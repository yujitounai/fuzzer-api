<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>プレースホルダ置換API - テストページ</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <!-- CodeMirror CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css" rel="stylesheet">
  
  <style>
    body { background-color: #f8f9fa; }
    .navbar-brand { font-weight: bold; }
    .card { box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075); border: none; margin-bottom: 1rem; }
    .card-header { background-color: #fff; border-bottom: 1px solid #dee2e6; font-weight: 600; }
    .btn-example { margin-right: 0.5rem; margin-bottom: 0.5rem; }
    .CodeMirror { height: auto; min-height: 120px; border: 1px solid #dee2e6; border-radius: 0.375rem; }
    .payload-set-card { border-left: 4px solid #007bff; }
    .payload-set-card .card-header { background-color: #f8f9fa; }
    .result-container { max-height: 500px; overflow-y: auto; }
    .strategy-badge { font-size: 0.875rem; }
    .loading-spinner { display: none; }
    .example-section { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem 0; margin-bottom: 2rem; }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
      <a class="navbar-brand" href="#"><i class="bi bi-bug"></i> プレースホルダ置換API</a>
      <div class="navbar-nav ms-auto">
        <a class="nav-link" href="/history-page"><i class="bi bi-clock-history"></i> 履歴</a>
        <a class="nav-link" href="/docs" target="_blank"><i class="bi bi-file-text"></i> API Docs</a>
      </div>
    </div>
  </nav>

  <!-- Example Section -->
  <div class="example-section">
    <div class="container">
      <h2 class="text-center mb-4"><i class="bi bi-lightning"></i> 攻撃戦略テスト</h2>
      <div class="text-center">
        <button class="btn btn-light btn-example" onclick="loadSniperExample()">
          <i class="bi bi-crosshair"></i> Sniper Attack
        </button>
        <button class="btn btn-light btn-example" onclick="loadBatteringRamExample()">
          <i class="bi bi-hammer"></i> Battering Ram Attack
        </button>
        <button class="btn btn-light btn-example" onclick="loadPitchforkExample()">
          <i class="bi bi-three-dots"></i> Pitchfork Attack
        </button>
        <button class="btn btn-light btn-example" onclick="loadClusterBombExample()">
          <i class="bi bi-grid-3x3"></i> Cluster Bomb Attack
        </button>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="row">
      <!-- Configuration Panel -->
      <div class="col-lg-6">
        <div class="card">
          <div class="card-header"><i class="bi bi-gear"></i> 設定</div>
          <div class="card-body">
            <div class="mb-3">
              <label for="strategy" class="form-label">戦略</label>
              <select id="strategy" class="form-select">
                <option value="sniper">Sniper Attack</option>
                <option value="battering_ram">Battering Ram Attack</option>
                <option value="pitchfork">Pitchfork Attack</option>
                <option value="cluster_bomb">Cluster Bomb Attack</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="template" class="form-label">テンプレート</label>
              <textarea id="template" class="form-control" rows="8" placeholder="例: GET /api/users?id=<<>> HTTP/1.1"></textarea>
            </div>
            <div class="mb-3">
              <label for="placeholders" class="form-label">プレースホルダ（カンマ区切り）</label>
              <input id="placeholders" type="text" class="form-control" placeholder="例: id,name">
            </div>
            <div class="mb-3">
              <label class="form-label">例を読み込む:</label>
              <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="loadSniperExample()">Sniper</button>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="loadBatteringRamExample()">Battering Ram</button>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="loadPitchforkExample()">Pitchfork</button>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="loadClusterBombExample()">Cluster Bomb</button>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="loadPostFormExample()">POST Form</button>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="loadPostJsonExample()">POST JSON</button>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="loadPostMultipartExample()">POST Multipart</button>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="loadMutationExample()">Mutation</button>
              </div>
            </div>
          </div>
        </div>

        <!-- JSON入力セクション -->
        <div class="card">
          <div class="card-header">
            <i class="bi bi-file-code"></i> JSON入力（Mutations形式）
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label class="form-label">
                <i class="bi bi-file-code"></i> JSONから読み込み（Mutations形式）
              </label>
              <div class="input-group">
                <textarea id="json-input" class="form-control" rows="6" placeholder='{
  "mutations": [
    {
      "token": "<<X>>",
      "strategy": "dictionary",
      "values": [
        "&lt;script&gt;",
        "\' OR 1=1 --",
        {
          "value": "ABC",
          "repeat": 3000
        }
      ]
    }
  ],
  "combo": "Sniper"
}'></textarea>
                <button class="btn btn-outline-primary" type="button" onclick="loadFromJson()">
                  <i class="bi bi-arrow-down-circle"></i> 読み込み
                </button>
              </div>
              <div class="mt-2">
                <button class="btn btn-sm btn-outline-secondary" onclick="loadSampleJson()">
                  <i class="bi bi-file-earmark-text"></i> Sniperサンプル
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="loadBatteringRamSampleJson()">
                  <i class="bi bi-file-earmark-text"></i> Battering Ramサンプル
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="loadPitchforkSampleJson()">
                  <i class="bi bi-file-earmark-text"></i> Pitchforkサンプル
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="loadClusterBombSampleJson()">
                  <i class="bi bi-file-earmark-text"></i> Cluster Bombサンプル
                </button>
              </div>
              <div class="form-text">
                Mutations形式のJSONを入力してペイロードを指定できます
              </div>
            </div>
          </div>
        </div>

        <div class="text-center">
          <button class="btn btn-success btn-lg" onclick="sendRequest()">
            <i class="bi bi-play-circle"></i> API実行
            <div class="spinner-border spinner-border-sm loading-spinner" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </button>
        </div>
      </div>

      <!-- Results Panel -->
      <div class="col-lg-6">
        <div class="card">
          <div class="card-header"><i class="bi bi-graph-up"></i> 結果</div>
          <div class="card-body">
            <div id="result" class="result-container">
              <div class="text-center text-muted">
                <i class="bi bi-arrow-right-circle" style="font-size: 2rem;"></i>
                <p>設定を入力して「API実行」をクリックしてください</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 実行設定モーダル -->
  <div class="modal fade" id="executeModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">HTTPリクエスト実行設定</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="execute-form">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="scheme" class="form-label">プロトコル</label>
                  <select class="form-select" id="scheme">
                    <option value="http">HTTP</option>
                    <option value="https">HTTPS</option>
                  </select>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="base-url" class="form-label">ベースURL</label>
                  <input type="text" class="form-control" id="base-url" value="localhost:8000" placeholder="example.com:443">
                </div>
              </div>
            </div>
            <div class="mb-3">
              <label for="timeout" class="form-label">タイムアウト（秒）</label>
              <input type="number" class="form-control" id="timeout" value="30" min="1" max="300">
            </div>
            <div class="mb-3">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="follow-redirects" checked>
                <label class="form-check-label" for="follow-redirects">
                  リダイレクトを追跡
                </label>
              </div>
            </div>
            <div class="mb-3">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="verify-ssl">
                <label class="form-check-label" for="verify-ssl">
                  SSL証明書を検証
                </label>
              </div>
            </div>
            <div class="mb-3">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="sequential-execution">
                <label class="form-check-label" for="sequential-execution">
                  同期実行（リクエストを順次実行）
                </label>
              </div>
              <div class="form-text">チェックすると、リクエストを並列ではなく順次実行します</div>
            </div>
            <div class="mb-3">
              <label for="request-delay" class="form-label">リクエスト間ウェイト（秒）</label>
              <input type="number" class="form-control" id="request-delay" value="0" min="0" max="60" step="0.1">
              <div class="form-text">同期実行時のリクエスト間の待機時間（0の場合はウェイトなし）</div>
            </div>
            <div class="mb-3">
              <label for="additional-headers" class="form-label">追加ヘッダー（JSON形式）</label>
              <textarea class="form-control" id="additional-headers" rows="3" placeholder='{"User-Agent": "Custom-Agent/1.0"}'></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <button type="button" class="btn btn-primary" onclick="confirmExecute()">
            <i class="bi bi-play"></i> 実行開始
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 実行結果モーダル -->
  <div class="modal fade" id="resultModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">HTTPリクエスト実行結果</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row mb-3">
            <div class="col-md-3">
              <div class="card bg-primary text-white">
                <div class="card-body text-center">
                  <h4 id="modal-total-executed">-</h4>
                  <p>総リクエスト数</p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card bg-success text-white">
                <div class="card-body text-center">
                  <h4 id="modal-successful-executed">-</h4>
                  <p>成功</p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card bg-danger text-white">
                <div class="card-body text-center">
                  <h4 id="modal-failed-executed">-</h4>
                  <p>失敗</p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card bg-info text-white">
                <div class="card-body text-center">
                  <h4 id="modal-success-rate">-</h4>
                  <p>成功率</p>
                </div>
              </div>
            </div>
          </div>
          <div id="modal-execution-results">
            <!-- 実行結果がここに表示されます -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- CodeMirror JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>

  <script>
    let codeMirrors = [];
    let templateCodeMirror = null;
    let jsonCodeMirror = null;

    function loadFromJson() {
      const jsonInput = jsonCodeMirror ? jsonCodeMirror.getValue().trim() : document.getElementById('json-input').value.trim();
      
      if (!jsonInput) {
        alert('JSONを入力してください');
        return;
      }
      
      try {
        const data = JSON.parse(jsonInput);
        
        // 戦略を設定（comboフィールドがある場合）
        if (data.combo) {
          const strategyMap = {
            'Sniper': 'sniper',
            'Battering Ram': 'battering_ram',
            'Pitchfork': 'pitchfork',
            'Cluster Bomb': 'cluster_bomb'
          };
          const strategy = strategyMap[data.combo] || 'sniper';
          document.getElementById('strategy').value = strategy;
        }
        
        // mutationsを処理してプレースホルダを設定
        if (data.mutations && Array.isArray(data.mutations)) {
          const placeholders = [];
          data.mutations.forEach((mutation) => {
            if (mutation.token) {
              // トークンをそのままプレースホルダとして使用（<<username>> -> <<username>>）
              if (!placeholders.includes(mutation.token)) {
                placeholders.push(mutation.token);
              }
            }
          });
          
          // プレースホルダフィールドを更新
          document.getElementById('placeholders').value = placeholders.join(', ');
        }
        
        // 成功メッセージ
        alert('JSONから設定を読み込みました！');
        
      } catch (error) {
        alert('JSONの解析に失敗しました: ' + error.message);
      }
    }

    function loadSniperExample() {
      document.getElementById('strategy').value = 'sniper';
      if (templateCodeMirror) {
        templateCodeMirror.setValue('GET /hack/normalxss.php?cmd=<<>> HTTP/1.1\nHost: bogus.jp\nUser-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/137.0.0.0 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7\nAccept-Encoding: gzip, deflate, br, zstd\nAccept-Language: ja,en-US;q=0.9,en;q=0.8');
      } else {
        document.getElementById('template').value = 'GET /hack/normalxss.php?cmd=<<>> HTTP/1.1\nHost: bogus.jp\nUser-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/137.0.0.0 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7\nAccept-Encoding: gzip, deflate, br, zstd\nAccept-Language: ja,en-US;q=0.9,en;q=0.8';
      }
      document.getElementById('placeholders').value = 'cmd,host';
    }

    function loadBatteringRamExample() {
      document.getElementById('strategy').value = 'battering_ram';
      if (templateCodeMirror) {
        templateCodeMirror.setValue('GET /hack/normalxss.php?username=<<username>>&password=<<password>>&email=<<email>> HTTP/1.1\nHost: bogus.jp\nUser-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/137.0.0.0 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7\nAccept-Encoding: gzip, deflate, br, zstd\nAccept-Language: ja,en-US;q=0.9,en;q=0.8');
      } else {
        document.getElementById('template').value = 'GET /hack/normalxss.php?username=<<username>>&password=<<password>>&email=<<email>> HTTP/1.1\nHost: bogus.jp\nUser-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/137.0.0.0 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7\nAccept-Encoding: gzip, deflate, br, zstd\nAccept-Language: ja,en-US;q=0.9,en;q=0.8';
      }
      document.getElementById('placeholders').value = 'username,password,email';
    }

    function loadPitchforkExample() {
      document.getElementById('strategy').value = 'pitchfork';
      if (templateCodeMirror) {
        templateCodeMirror.setValue('GET /get?username=<<username>>&user_id=<<user_id>>&role=<<role>> HTTP/1.1\nHost: httpbin.org\nUser-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/137.0.0.0 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7\nAccept-Encoding: gzip, deflate, br, zstd\nAccept-Language: ja,en-US;q=0.9,en;q=0.8');
      } else {
        document.getElementById('template').value = 'GET /get?username=<<username>>&user_id=<<user_id>>&role=<<role>> HTTP/1.1\nHost: httpbin.org\nUser-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/137.0.0.0 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7\nAccept-Encoding: gzip, deflate, br, zstd\nAccept-Language: ja,en-US;q=0.9,en;q=0.8';
      }
      document.getElementById('placeholders').value = 'username,user_id,role';
    }

    function loadClusterBombExample() {
      document.getElementById('strategy').value = 'cluster_bomb';
      if (templateCodeMirror) {
        templateCodeMirror.setValue('GET /get?username=<<username>>&password=<<password>> HTTP/1.1\nHost: httpbin.org\nUser-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/137.0.0.0 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7\nAccept-Encoding: gzip, deflate, br, zstd\nAccept-Language: ja,en-US;q=0.9,en;q=0.8');
      } else {
        document.getElementById('template').value = 'GET /get?username=<<username>>&password=<<password>> HTTP/1.1\nHost: httpbin.org\nUser-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/137.0.0.0 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7\nAccept-Encoding: gzip, deflate, br, zstd\nAccept-Language: ja,en-US;q=0.9,en;q=0.8';
      }
      document.getElementById('placeholders').value = 'username,password';
    }

    function loadPostFormExample() {
      document.getElementById('strategy').value = 'sniper';
      const templateValue = `POST /api/login HTTP/1.1
Host: httpbin.org
Content-Type: application/x-www-form-urlencoded
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: ja,en-US;q=0.9,en;q=0.8
Accept-Encoding: gzip, deflate, br
Connection: keep-alive
Content-Length: <<>>

username=<<>>&password=<<>>&submit=Login`;
      
      if (templateCodeMirror) {
        templateCodeMirror.setValue(templateValue);
      } else {
        document.getElementById('template').value = templateValue;
      }
      document.getElementById('placeholders').value = 'content_length,username,password';
    }

    function loadPostJsonExample() {
      document.getElementById('strategy').value = 'sniper';
      const templateValue = `POST /api/users HTTP/1.1
Host: httpbin.org
Content-Type: application/json
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36
Accept: application/json
Authorization: Bearer <<>>
Content-Length: <<>>

{"username": "<<>>", "email": "<<>>", "role": "user"}`;
      
      if (templateCodeMirror) {
        templateCodeMirror.setValue(templateValue);
      } else {
        document.getElementById('template').value = templateValue;
      }
      document.getElementById('placeholders').value = 'auth_token,content_length,username,email';
    }

    function loadPostMultipartExample() {
      document.getElementById('strategy').value = 'sniper';
      const templateValue = `POST /post HTTP/1.1
Host: httpbin.org
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary<<>>
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36
Accept: application/json
Content-Length: <<>>

------WebKitFormBoundary<<>>
Content-Disposition: form-data; name="file"; filename="<<>>"
Content-Type: application/octet-stream

<<>>
------WebKitFormBoundary<<>>
Content-Disposition: form-data; name="description"

<<>>
------WebKitFormBoundary<<>>--`;
      
      if (templateCodeMirror) {
        templateCodeMirror.setValue(templateValue);
      } else {
        document.getElementById('template').value = templateValue;
      }
      document.getElementById('placeholders').value = 'boundary1,content_length,boundary2,filename,file_content,boundary3,description,boundary4';
    }

    function loadMutationExample() {
      // 戦略をmutationに設定
      document.getElementById('strategy').value = 'mutation';
      
      // テンプレートを設定
      const templateValue = `GET /api/test?param=<<X>> HTTP/1.1
    Host: httpbin.org
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8`;
      
      if (templateCodeMirror) {
        templateCodeMirror.setValue(templateValue);
      } else {
        document.getElementById('template').value = templateValue;
      }
      
      // プレースホルダを設定
      document.getElementById('placeholders').value = 'X';
      
      // ペイロードセットをクリア
      const payloadSets = document.getElementById('payload-sets');
      payloadSets.innerHTML = '';
      codeMirrors = [];
      
      // 変異の例を設定（実際のAPIでは別のエンドポイントを使用）
      alert('Mutation機能の例:\n\n' +
            '{\n' +
            '  "template": "GET /api/test?param=<<X>> HTTP/1.1\\nHost: httpbin.org",\n' +
            '  "mutations": [\n' +
            '    {\n' +
            '      "token": "<<X>>",\n' +
            '      "strategy": "dictionary",\n' +
            '      "values": [\n' +
            '        "<script>alert(\\"XSS\\")<\/script>",\n' +
            '        "\' OR 1=1 --",\n' +
            '        {\n' +
            '          "value": "A",\n' +
            '          "repeat": 1000\n' +
            '        }\n' +
            '      ]\n' +
            '    }\n' +
            '  ]\n' +
            '}\n\n' +
            'この機能は /api/mutations エンドポイントで利用できます。');
    }

    function loadSampleJson() {
      const sampleJson = [
        '{',
        '  "mutations": [',
        '    {',
        '      "token": "<<X>>",',
        '      "strategy": "dictionary",',
        '      "values": [',
        '        "<script>alert(\\"XSS\\")<\/script>",',
        '        "\' OR 1=1 --",',
        '        { "value": "A", "repeat": 3000 }',
        '      ]',
        '    }',
        '  ],',
        '  "combo": "Sniper"',
        '}'
      ].join('\n');
      if (jsonCodeMirror) {
        jsonCodeMirror.setValue(sampleJson);
      } else {
        document.getElementById('json-input').value = sampleJson;
      }
    }

    function loadBatteringRamSampleJson() {
      const sampleJson = [
        '{',
        '  "mutations": [',
        '    {',
        '      "token": "<<username>>",',
        '      "strategy": "dictionary",',
        '      "values": [',
        '        "admin",',
        '        "test",',
        '        "guest",',
        '        "root"',
        '      ]',
        '    },',
        '    {',
        '      "token": "<<password>>",',
        '      "strategy": "dictionary",',
        '      "values": [',
        '        "admin",',
        '        "test",',
        '        "guest",',
        '        "root"',
        '      ]',
        '    },',
        '    {',
        '      "token": "<<email>>",',
        '      "strategy": "dictionary",',
        '      "values": [',
        '        "admin@example.com",',
        '        "test@example.com",',
        '        "guest@example.com",',
        '        "root@example.com"',
        '      ]',
        '    }',
        '  ],',
        '  "combo": "Battering Ram"',
        '}'
      ].join('\n');
      if (jsonCodeMirror) {
        jsonCodeMirror.setValue(sampleJson);
      } else {
        document.getElementById('json-input').value = sampleJson;
      }
    }

    function loadPitchforkSampleJson() {
      const sampleJson = [
        '{',
        '  "mutations": [',
        '    {',
        '      "token": "<<username>>",',
        '      "strategy": "dictionary",',
        '      "values": [',
        '        "admin",',
        '        "user",',
        '        "guest"',
        '      ]',
        '    },',
        '    {',
        '      "token": "<<user_id>>",',
        '      "strategy": "dictionary",',
        '      "values": [',
        '        "1",',
        '        "2",',
        '        "3"',
        '      ]',
        '    },',
        '    {',
        '      "token": "<<role>>",',
        '      "strategy": "dictionary",',
        '      "values": [',
        '        "admin",',
        '        "user",',
        '        "guest"',
        '      ]',
        '    }',
        '  ],',
        '  "combo": "Pitchfork"',
        '}'
      ].join('\n');
      if (jsonCodeMirror) {
        jsonCodeMirror.setValue(sampleJson);
      } else {
        document.getElementById('json-input').value = sampleJson;
      }
    }

    function loadClusterBombSampleJson() {
      const sampleJson = [
        '{',
        '  "mutations": [',
        '    {',
        '      "token": "<<username>>",',
        '      "strategy": "dictionary",',
        '      "values": [',
        '        "admin",',
        '        "user",',
        '        "test"',
        '      ]',
        '    },',
        '    {',
        '      "token": "<<password>>",',
        '      "strategy": "dictionary",',
        '      "values": [',
        '        "password",',
        '        "123456",',
        '        "admin"',
        '      ]',
        '    }',
        '  ],',
        '  "combo": "Cluster Bomb"',
        '}'
      ].join('\n');
      if (jsonCodeMirror) {
        jsonCodeMirror.setValue(sampleJson);
      } else {
        document.getElementById('json-input').value = sampleJson;
      }
    }

    async function sendRequest() {
      const strategy = document.getElementById('strategy').value;
      const template = templateCodeMirror ? templateCodeMirror.getValue() : document.getElementById('template').value;
      const placeholders = document.getElementById('placeholders').value.split(',').map(s => s.trim()).filter(Boolean);
      
      // JSON入力からmutationsデータを取得
      const jsonInput = jsonCodeMirror ? jsonCodeMirror.getValue().trim() : document.getElementById('json-input').value.trim();
      
      if (!jsonInput) {
        alert('JSONを入力してください');
        return;
      }
      
      let payloadSets = [];
      
      try {
        const data = JSON.parse(jsonInput);
        
        // mutationsデータをペイロードセット形式に変換
        if (data.mutations && Array.isArray(data.mutations)) {
          data.mutations.forEach((mutation) => {
            if (mutation.token && mutation.values && Array.isArray(mutation.values)) {
              const payloads = mutation.values.map(value => {
                if (typeof value === 'string') {
                  return value;
                } else if (typeof value === 'object' && value.value && value.repeat) {
                  // repeat機能の場合は実際の値を展開
                  return value.value.repeat(value.repeat);
                }
                return JSON.stringify(value);
              }).filter(p => p.trim());
              
              if (payloads.length > 0) {
                payloadSets.push({
                  name: mutation.token,
                  payloads: payloads
                });
              }
            }
          });
        }
      } catch (error) {
        alert('JSONの解析に失敗しました: ' + error.message);
        return;
      }

      const body = { template, placeholders, strategy, payload_sets: payloadSets };

      const button = document.querySelector('.btn-success');
      const spinner = button.querySelector('.loading-spinner');
      button.disabled = true;
      spinner.style.display = 'inline-block';
      
      document.getElementById('result').innerHTML = `
        <div class="text-center">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2">リクエスト送信中...</p>
        </div>
      `;

      try {
        // 新しい直感的なAPIエンドポイントを使用
        const intuitiveBody = {
          template: template,
          strategy: strategy,
          payload_sets: payloadSets.map(payloadSet => ({
            token: payloadSet.name,
            strategy: "dictionary", // デフォルト戦略
            values: payloadSet.payloads
          }))
        };
        
        const response = await fetch('/api/intuitive', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(intuitiveBody)
        });

        const result = await response.json();
        
        if (response.ok) {
          // リクエスト結果を保存
          lastRequestResult = result;
          displayResults(result);
        } else {
          document.getElementById('result').innerHTML = `
            <div class="alert alert-danger">
              <h5><i class="bi bi-exclamation-triangle"></i> エラー</h5>
              <p>${result.detail || 'リクエストに失敗しました'}</p>
            </div>
          `;
        }
      } catch (error) {
        document.getElementById('result').innerHTML = `
          <div class="alert alert-danger">
            <h5><i class="bi bi-exclamation-triangle"></i> エラー</h5>
            <p>ネットワークエラー: ${error.message}</p>
          </div>
        `;
      } finally {
        button.disabled = false;
        spinner.style.display = 'none';
      }
    }

    function displayResults(result) {
      const resultDiv = document.getElementById('result');
      
      if (!result.requests || result.requests.length === 0) {
        resultDiv.innerHTML = `
          <div class="alert alert-warning">
            <h5><i class="bi bi-exclamation-triangle"></i> 警告</h5>
            <p>生成されたリクエストがありません</p>
          </div>
        `;
        return;
      }

      let html = `
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5><i class="bi bi-check-circle text-success"></i> 成功</h5>
          <div>
            <span class="badge bg-primary me-2">${result.requests.length} リクエスト生成</span>
            <button class="btn btn-success btn-sm" onclick="executeJob()">
              <i class="bi bi-play-circle"></i> ジョブ実行
            </button>
          </div>
        </div>
        <div class="accordion" id="resultsAccordion">
      `;

      result.requests.forEach((request, index) => {
        const accordionId = `accordion-${index}`;
        const collapseId = `collapse-${index}`;
        const isFirst = index === 0;
        
        html += `
          <div class="accordion-item">
            <h2 class="accordion-header" id="${accordionId}">
              <button class="accordion-button ${isFirst ? '' : 'collapsed'}" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="${isFirst ? 'true' : 'false'}" aria-controls="${collapseId}">
                <i class="bi bi-file-text me-2"></i> リクエスト ${index + 1}
                ${request.strategy ? `<span class="badge bg-secondary strategy-badge ms-auto">${request.strategy}</span>` : ''}
              </button>
            </h2>
            <div id="${collapseId}" class="accordion-collapse collapse ${isFirst ? 'show' : ''}" aria-labelledby="${accordionId}" data-bs-parent="#resultsAccordion">
              <div class="accordion-body">
                <pre class="mb-0" style="white-space: pre-wrap; word-break: break-all;">${escapeHtml(request.request)}</pre>
              </div>
            </div>
          </div>
        `;
      });

      html += '</div>';
      resultDiv.innerHTML = html;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // グローバル変数で最後のリクエスト結果を保存
    let lastRequestResult = null;

            // ジョブ実行機能
        async function executeJob() {
          if (!lastRequestResult) {
            alert('実行するリクエストがありません。先にAPIを実行してください。');
            return;
          }

          // 実行設定モーダルを表示
          const executeModal = new bootstrap.Modal(document.getElementById('executeModal'));
          executeModal.show();
        }

        // 実行を確認して開始
        async function confirmExecute() {
          if (!lastRequestResult) {
            alert('実行するリクエストがありません。');
            return;
          }

          // 設定を取得
          const scheme = document.getElementById('scheme').value;
          const baseUrl = document.getElementById('base-url').value;
          const timeout = parseInt(document.getElementById('timeout').value);
          const followRedirects = document.getElementById('follow-redirects').checked;
          const verifySsl = document.getElementById('verify-ssl').checked;
          const sequentialExecution = document.getElementById('sequential-execution').checked;
          const requestDelay = parseFloat(document.getElementById('request-delay').value);
          const additionalHeadersText = document.getElementById('additional-headers').value;

          let additionalHeaders = null;
          if (additionalHeadersText.trim()) {
            try {
              additionalHeaders = JSON.parse(additionalHeadersText);
            } catch (e) {
              alert('追加ヘッダーのJSON形式が正しくありません。');
              return;
            }
          }

          // 実行設定モーダルを閉じる
          const executeModal = bootstrap.Modal.getInstance(document.getElementById('executeModal'));
          executeModal.hide();

          // 実行開始
          try {
            const response = await fetch('/api/execute-requests', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                request_id: lastRequestResult.request_id,
                http_config: {
                  scheme: scheme,
                  base_url: baseUrl,
                  timeout: timeout,
                  follow_redirects: followRedirects,
                  verify_ssl: verifySsl,
                  sequential_execution: sequentialExecution,
                  request_delay: requestDelay,
                  additional_headers: additionalHeaders
                }
              })
            });

            const result = await response.json();
            
            if (response.ok) {
              // ジョブIDを取得してポーリング開始
              if (result.job_id) {
                pollJobResultModal(result.job_id);
              } else {
                showExecutionResults(result);
              }
            } else {
              alert(`ジョブ実行に失敗しました: ${result.detail || 'エラーが発生しました'}`);
            }
          } catch (error) {
            alert(`ジョブ実行に失敗しました: ${error.message}`);
          }
        }

        // ジョブ結果をポーリング（メインページ用）
        async function pollJobResult(jobId) {
          const maxAttempts = 60; // 最大60回試行（5分間）
          let attempts = 0;
          
          // 実行中メッセージを表示
          const resultDiv = document.getElementById('result');
          resultDiv.innerHTML = `
            <div class="text-center p-4">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">実行中...</span>
              </div>
              <p class="mt-2">ジョブ実行中... (${attempts}/${maxAttempts})</p>
              <small class="text-muted">ジョブID: ${jobId.substring(0, 8)}...</small>
            </div>
          `;

          const pollInterval = setInterval(async () => {
            attempts++;
            
            try {
              const response = await fetch(`/api/jobs/${jobId}`);
              const job = await response.json();
              
              // 実行中メッセージを更新
              resultDiv.innerHTML = `
                <div class="text-center p-4">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">実行中...</span>
                  </div>
                  <p class="mt-2">ジョブ実行中... (${attempts}/${maxAttempts})</p>
                  <p class="text-muted">ステータス: ${getJobStatusText(job.status)}</p>
                  <small class="text-muted">ジョブID: ${jobId.substring(0, 8)}...</small>
                </div>
              `;
              
              // ジョブが完了したかチェック
              if (job.status === 'completed' || job.status === 'failed' || job.status === 'cancelled') {
                clearInterval(pollInterval);
                
                if (job.status === 'completed') {
                  // ジョブの結果を取得
                  const jobResults = await fetchJobResults(jobId);
                  console.log('Job results from fetchJobResults:', jobResults); // デバッグ用
                  
                  displayJobResult({
                    total_requests: job.progress?.total_requests || jobResults.length,
                    successful_requests: job.progress?.successful_requests || jobResults.filter(r => r.http_response?.status_code && r.http_response.status_code >= 200 && r.http_response.status_code < 400).length,
                    failed_requests: job.progress?.failed_requests || jobResults.filter(r => r.http_response?.error || !r.http_response?.status_code).length,
                    results: jobResults
                  });
                } else {
                  resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                      <h5><i class="bi bi-exclamation-triangle"></i> ジョブ実行失敗</h5>
                      <p>ジョブが${getJobStatusText(job.status)}状態で終了しました。</p>
                      <small>ジョブID: ${jobId}</small>
                    </div>
                  `;
                }
              }
              
              // 最大試行回数に達した場合
              if (attempts >= maxAttempts) {
                clearInterval(pollInterval);
                resultDiv.innerHTML = `
                  <div class="alert alert-warning">
                    <h5><i class="bi bi-clock"></i> タイムアウト</h5>
                    <p>ジョブの実行がタイムアウトしました。後で履歴ページで結果を確認してください。</p>
                    <small>ジョブID: ${jobId}</small>
                  </div>
                `;
              }
              
            } catch (error) {
              console.error('ジョブ状態の取得に失敗しました:', error);
              attempts++;
              
              if (attempts >= maxAttempts) {
                clearInterval(pollInterval);
                resultDiv.innerHTML = `
                  <div class="alert alert-danger">
                    <h5><i class="bi bi-exclamation-triangle"></i> エラー</h5>
                    <p>ジョブ状態の取得に失敗しました。</p>
                    <small>ジョブID: ${jobId}</small>
                  </div>
                `;
              }
            }
          }, 5000); // 5秒間隔でポーリング
        }

        // ジョブ結果をポーリング（モーダル用）
        async function pollJobResultModal(jobId) {
          const maxAttempts = 60; // 最大60回試行（5分間）
          let attempts = 0;
          
          // 実行中メッセージを表示
          const resultModal = new bootstrap.Modal(document.getElementById('resultModal'));
          const resultsDiv = document.getElementById('modal-execution-results');
          resultsDiv.innerHTML = `
            <div class="text-center p-4">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">実行中...</span>
              </div>
              <p class="mt-2">ジョブ実行中... (${attempts}/${maxAttempts})</p>
              <small class="text-muted">ジョブID: ${jobId.substring(0, 8)}...</small>
            </div>
          `;
          resultModal.show();

          const pollInterval = setInterval(async () => {
            attempts++;
            
            try {
              const response = await fetch(`/api/jobs/${jobId}`);
              const job = await response.json();
              
              // 実行中メッセージを更新
              resultsDiv.innerHTML = `
                <div class="text-center p-4">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">実行中...</span>
                  </div>
                  <p class="mt-2">ジョブ実行中... (${attempts}/${maxAttempts})</p>
                  <p class="text-muted">ステータス: ${getJobStatusText(job.status)}</p>
                  <p class="text-muted">進捗: ${job.progress?.completed_requests || 0}/${job.progress?.total_requests || 0} (${job.progress?.progress_percentage?.toFixed(1) || 0}%)</p>
                  <small class="text-muted">ジョブID: ${jobId.substring(0, 8)}...</small>
                </div>
              `;
              
              // ジョブが完了したかチェック
              if (job.status === 'completed' || job.status === 'failed' || job.status === 'cancelled') {
                clearInterval(pollInterval);
                
                if (job.status === 'completed') {
                  // 結果データを取得して表示
                  try {
                    const resultsResponse = await fetch(`/api/jobs/${jobId}/results`);
                    const resultsData = await resultsResponse.json();
                    
                    console.log('Results data from API:', resultsData); // デバッグ用
                    
                    // resultsDataが配列かオブジェクトかをチェック
                    let results = [];
                    if (Array.isArray(resultsData)) {
                      results = resultsData;
                    } else if (resultsData.results) {
                      results = resultsData.results;
                    } else if (resultsData.items) {
                      results = resultsData.items;
                    }
                    
                    console.log('Processed results:', results); // デバッグ用
                    
                    showExecutionResults({
                      total_requests: job.progress?.total_requests || results.length,
                      successful_requests: job.progress?.successful_requests || results.filter(r => r.http_response?.status_code && r.http_response.status_code >= 200 && r.http_response.status_code < 400).length,
                      failed_requests: job.progress?.failed_requests || results.filter(r => r.http_response?.error || !r.http_response?.status_code).length,
                      results: results
                    });
                  } catch (error) {
                    console.error('結果データの取得に失敗しました:', error);
                    resultsDiv.innerHTML = `
                      <div class="alert alert-warning">
                        <h5><i class="bi bi-exclamation-triangle"></i> 警告</h5>
                        <p>ジョブは完了しましたが、結果データの取得に失敗しました。</p>
                        <small>ジョブID: ${jobId}</small>
                      </div>
                    `;
                  }
                } else {
                  resultsDiv.innerHTML = `
                    <div class="alert alert-danger">
                      <h5><i class="bi bi-exclamation-triangle"></i> ジョブ実行失敗</h5>
                      <p>ジョブが${getJobStatusText(job.status)}状態で終了しました。</p>
                      <small>ジョブID: ${jobId}</small>
                    </div>
                  `;
                }
              }
              
              // 最大試行回数に達した場合
              if (attempts >= maxAttempts) {
                clearInterval(pollInterval);
                resultsDiv.innerHTML = `
                  <div class="alert alert-warning">
                    <h5><i class="bi bi-clock"></i> タイムアウト</h5>
                    <p>ジョブの実行がタイムアウトしました。後で履歴ページで結果を確認してください。</p>
                    <small>ジョブID: ${jobId}</small>
                  </div>
                `;
              }
              
            } catch (error) {
              console.error('ジョブ状態の取得に失敗しました:', error);
              attempts++;
              
              if (attempts >= maxAttempts) {
                clearInterval(pollInterval);
                resultsDiv.innerHTML = `
                  <div class="alert alert-danger">
                    <h5><i class="bi bi-exclamation-triangle"></i> エラー</h5>
                    <p>ジョブ状態の取得に失敗しました。</p>
                    <small>ジョブID: ${jobId}</small>
                  </div>
                `;
              }
            }
          }, 5000); // 5秒間隔でポーリング
        }

        // 実行結果をモーダルで表示
        function showExecutionResults(result) {
          console.log('showExecutionResults called with:', result); // デバッグ用
          
          // 統計情報を更新
          document.getElementById('modal-total-executed').textContent = result.total_requests || 0;
          document.getElementById('modal-successful-executed').textContent = result.successful_requests || 0;
          document.getElementById('modal-failed-executed').textContent = result.failed_requests || 0;
          
          const successRate = result.total_requests > 0 ? 
            ((result.successful_requests || 0) / result.total_requests * 100).toFixed(1) + '%' : '0%';
          document.getElementById('modal-success-rate').textContent = successRate;
          
          // 詳細結果を表示
          const resultsDiv = document.getElementById('modal-execution-results');
          if (result.results && result.results.length > 0) {
            let html = '<div class="table-responsive"><table class="table table-sm table-striped">';
            html += '<thead><tr><th>#</th><th>ステータス</th><th>レスポンス時間</th><th>URL</th><th>エラー</th></tr></thead><tbody>';
            
            result.results.forEach((req, index) => {
              console.log(`Result ${index + 1}:`, req); // デバッグ用
              
              // http_response が存在するかチェック
              const httpResponse = req.http_response || req;
              const isSuccess = httpResponse.status_code && httpResponse.status_code >= 200 && httpResponse.status_code < 400;
              const statusClass = isSuccess ? 'text-success' : 'text-danger';
              
              // ステータスコードの処理
              let statusText;
              if (httpResponse.status_code) {
                statusText = `HTTP ${httpResponse.status_code}`;
              } else if (httpResponse.error) {
                statusText = 'エラー';
              } else {
                statusText = 'N/A';
              }
              
              // レスポンス時間の処理
              let elapsedTime = 'N/A';
              if (httpResponse.elapsed_time !== undefined && httpResponse.elapsed_time !== null) {
                elapsedTime = httpResponse.elapsed_time.toFixed(3) + 's';
              }
              
              // URLの処理
              let url = httpResponse.url || 'N/A';
              
              // エラーの処理
              let error = httpResponse.error || '-';
              
              html += `
                <tr>
                  <td>${index + 1}</td>
                  <td class="${statusClass}">
                    <i class="bi bi-${isSuccess ? 'check' : 'x'}"></i>
                    ${statusText}
                  </td>
                  <td>${elapsedTime}</td>
                  <td class="text-truncate" style="max-width: 200px;" title="${url}">${url}</td>
                  <td class="text-truncate" style="max-width: 150px;" title="${error}">${error}</td>
                </tr>
              `;
            });
            
            html += '</tbody></table></div>';
            resultsDiv.innerHTML = html;
          } else {
            resultsDiv.innerHTML = `
              <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> 実行結果がありません。
              </div>
            `;
          }
        }

        // ジョブステータスの日本語表示
        function getJobStatusText(status) {
          const texts = {
            'pending': '待機中',
            'running': '実行中',
            'completed': '完了',
            'failed': '失敗',
            'cancelled': 'キャンセル'
          };
          return texts[status] || status;
        }

        // ジョブの結果を取得
        async function fetchJobResults(jobId) {
          try {
            const response = await fetch(`/api/jobs/${jobId}/results`);
            if (!response.ok) {
              console.error('ジョブ結果の取得に失敗しました:', response.status);
              return [];
            }
            const data = await response.json();
            console.log('fetchJobResults raw data:', data); // デバッグ用
            
            // データ構造を確認して適切な配列を返す
            if (Array.isArray(data)) {
              return data;
            } else if (data.results && Array.isArray(data.results)) {
              return data.results;
            } else if (data.items && Array.isArray(data.items)) {
              return data.items;
            } else {
              console.warn('Unexpected data structure:', data);
              return [];
            }
          } catch (error) {
            console.error('ジョブ結果の取得エラー:', error);
            return [];
          }
        }

    function displayJobResult(result) {
      console.log('displayJobResult called with:', result); // デバッグ用
      const resultDiv = document.getElementById('result');
      
      let html = `
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5><i class="bi bi-check-circle text-success"></i> ジョブ実行完了</h5>
          <div>
            <span class="badge bg-success me-2">成功: ${result.successful_requests}</span>
            <span class="badge bg-danger me-2">失敗: ${result.failed_requests}</span>
            <span class="badge bg-primary">総数: ${result.total_requests}</span>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-sm table-striped">
            <thead>
              <tr>
                <th>#</th>
                <th>ステータス</th>
                <th>レスポンス時間</th>
                <th>URL</th>
                <th>エラー</th>
              </tr>
            </thead>
            <tbody>
      `;

      if (result.results && result.results.length > 0) {
        result.results.forEach((req, index) => {
          console.log(`displayJobResult item ${index + 1}:`, req); // デバッグ用
          
          // http_response が存在するかチェック
          const httpResponse = req.http_response || req;
          const isSuccess = httpResponse.status_code && httpResponse.status_code >= 200 && httpResponse.status_code < 400;
          const statusClass = isSuccess ? 'text-success' : 'text-danger';
          
          // ステータスコードの処理
          let statusText;
          if (httpResponse.status_code) {
            statusText = `HTTP ${httpResponse.status_code}`;
          } else if (httpResponse.error) {
            statusText = 'エラー';
          } else {
            statusText = 'N/A';
          }
          
          // レスポンス時間の処理
          let elapsedTime = 'N/A';
          if (httpResponse.elapsed_time !== undefined && httpResponse.elapsed_time !== null) {
            elapsedTime = httpResponse.elapsed_time.toFixed(3) + 's';
          }
          
          // URLの処理
          let url = httpResponse.url || 'N/A';
          
          // エラーの処理
          let error = httpResponse.error || '-';
          
          html += `
            <tr>
              <td>${index + 1}</td>
              <td class="${statusClass}">
                <i class="bi bi-${isSuccess ? 'check' : 'x'}"></i>
                ${statusText}
              </td>
              <td>${elapsedTime}</td>
              <td class="text-truncate" style="max-width: 200px;" title="${url}">${url}</td>
              <td class="text-truncate" style="max-width: 150px;" title="${error}">${error}</td>
            </tr>
          `;
        });
      } else {
        html += `
          <tr>
            <td colspan="5" class="text-center text-muted">
              <i class="bi bi-info-circle"></i> 実行結果がありません
            </td>
          </tr>
        `;
      }

      html += `
            </tbody>
          </table>
        </div>
        <div class="mt-3">
          <a href="/history-page" class="btn btn-primary">
            <i class="bi bi-clock-history"></i> 履歴ページで詳細を確認
          </a>
        </div>
      `;

      resultDiv.innerHTML = html;
    }

    // 初期化処理
    document.addEventListener('DOMContentLoaded', function() {
      // CodeMirrorの初期化
      templateCodeMirror = CodeMirror.fromTextArea(document.getElementById('template'), {
        mode: 'text/plain',
        theme: 'monokai',
        lineNumbers: true,
        lineWrapping: true,
        indentUnit: 2,
        tabSize: 2,
        extraKeys: {
          'Tab': function(cm) {
            cm.replaceSelection('  ', 'end');
          }
        }
      });

      jsonCodeMirror = CodeMirror.fromTextArea(document.getElementById('json-input'), {
        mode: 'application/json',
        theme: 'monokai',
        lineNumbers: true,
        lineWrapping: true,
        indentUnit: 2,
        tabSize: 2,
        extraKeys: {
          'Tab': function(cm) {
            cm.replaceSelection('  ', 'end');
          }
        }
      });

      // デフォルトのSniperサンプルを読み込み
      loadSampleJson();
      
      // デフォルトのテンプレートも読み込み
      loadSniperExample();
    });
  </script>
</body>
</html>