<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>プレースホルダ置換API - テストページ</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <!-- CodeMirror CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css" rel="stylesheet">
  
  <style>
    body { background-color: #f8f9fa; }
    .navbar-brand { font-weight: bold; }
    .card { box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075); border: none; margin-bottom: 1rem; }
    .card-header { background-color: #fff; border-bottom: 1px solid #dee2e6; font-weight: 600; }
    .btn-example { margin-right: 0.5rem; margin-bottom: 0.5rem; }
    .CodeMirror { height: auto; min-height: 120px; border: 1px solid #dee2e6; border-radius: 0.375rem; }
    .payload-set-card { border-left: 4px solid #007bff; }
    .payload-set-card .card-header { background-color: #f8f9fa; }
    .result-container { max-height: 500px; overflow-y: auto; }
    .strategy-badge { font-size: 0.875rem; }
    .loading-spinner { display: none; }
    .example-section { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem 0; margin-bottom: 2rem; }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
      <a class="navbar-brand" href="#"><i class="bi bi-bug"></i> プレースホルダ置換API</a>
      <div class="navbar-nav ms-auto">
        <a class="nav-link" href="/docs" target="_blank"><i class="bi bi-file-text"></i> API Docs</a>
      </div>
    </div>
  </nav>

  <!-- Example Section -->
  <div class="example-section">
    <div class="container">
      <h2 class="text-center mb-4"><i class="bi bi-lightning"></i> 攻撃戦略テスト</h2>
      <div class="text-center">
        <button class="btn btn-light btn-example" onclick="loadSniperExample()">
          <i class="bi bi-crosshair"></i> Sniper Attack
        </button>
        <button class="btn btn-light btn-example" onclick="loadBatteringRamExample()">
          <i class="bi bi-hammer"></i> Battering Ram Attack
        </button>
        <button class="btn btn-light btn-example" onclick="loadPitchforkExample()">
          <i class="bi bi-three-dots"></i> Pitchfork Attack
        </button>
        <button class="btn btn-light btn-example" onclick="loadClusterBombExample()">
          <i class="bi bi-grid-3x3"></i> Cluster Bomb Attack
        </button>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="row">
      <!-- Configuration Panel -->
      <div class="col-lg-6">
        <div class="card">
          <div class="card-header"><i class="bi bi-gear"></i> 設定</div>
          <div class="card-body">
            <div class="mb-3">
              <label for="strategy" class="form-label">戦略</label>
              <select id="strategy" class="form-select">
                <option value="sniper">Sniper Attack</option>
                <option value="battering_ram">Battering Ram Attack</option>
                <option value="pitchfork">Pitchfork Attack</option>
                <option value="cluster_bomb">Cluster Bomb Attack</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="template" class="form-label">テンプレート</label>
              <textarea id="template" placeholder="例: GET /api/users?id=<<>> HTTP/1.1"></textarea>
            </div>
            <div class="mb-3">
              <label for="placeholders" class="form-label">プレースホルダ（カンマ区切り）</label>
              <input id="placeholders" type="text" class="form-control" placeholder="例: id,name">
            </div>
            <div class="mb-3">
              <label class="form-label">例を読み込む:</label>
              <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="loadSniperExample()">Sniper</button>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="loadBatteringRamExample()">Battering Ram</button>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="loadPitchforkExample()">Pitchfork</button>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="loadClusterBombExample()">Cluster Bomb</button>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="loadPostFormExample()">POST Form</button>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="loadPostJsonExample()">POST JSON</button>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="loadPostMultipartExample()">POST Multipart</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Payload Sets -->
        <div class="card">
          <div class="card-header">
            <i class="bi bi-list-ul"></i> ペイロードセット
            <button class="btn btn-sm btn-primary float-end" onclick="addPayloadSet()">
              <i class="bi bi-plus"></i> 追加
            </button>
          </div>
          <div class="card-body">
            <div id="payload-sets"></div>
          </div>
        </div>

        <div class="text-center">
          <button class="btn btn-success btn-lg" onclick="sendRequest()">
            <i class="bi bi-play-circle"></i> API実行
            <div class="spinner-border spinner-border-sm loading-spinner" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </button>
        </div>
      </div>

      <!-- Results Panel -->
      <div class="col-lg-6">
        <div class="card">
          <div class="card-header"><i class="bi bi-graph-up"></i> 結果</div>
          <div class="card-body">
            <div id="result" class="result-container">
              <div class="text-center text-muted">
                <i class="bi bi-arrow-right-circle" style="font-size: 2rem;"></i>
                <p>設定を入力して「API実行」をクリックしてください</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- CodeMirror JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>

  <script>
    let codeMirrors = [];
    let templateCodeMirror = null;

    function createPayloadSet(name = '', payloads = '') {
      const payloadSetId = 'payload-set-' + Date.now();
      const html = `
        <div class="card payload-set-card mb-3" id="${payloadSetId}">
          <div class="card-header">
            <div class="row align-items-center">
              <div class="col">
                <input type="text" class="form-control form-control-sm" placeholder="ペイロードセット名" value="${name}">
              </div>
              <div class="col-auto">
                <button class="btn btn-sm btn-outline-danger" onclick="removePayloadSet('${payloadSetId}')">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </div>
          </div>
          <div class="card-body">
            <textarea class="payload-textarea" placeholder="ペイロード（改行区切り）">${payloads}</textarea>
          </div>
        </div>
      `;
      
      const container = document.getElementById('payload-sets');
      container.insertAdjacentHTML('beforeend', html);
      
      const textarea = container.querySelector(`#${payloadSetId} .payload-textarea`);
      const cm = CodeMirror.fromTextArea(textarea, {
        mode: 'text/plain',
        theme: 'monokai',
        lineNumbers: true,
        lineWrapping: true,
        indentUnit: 2,
        tabSize: 2
      });
      codeMirrors.push(cm);
    }

    function removePayloadSet(id) {
      const element = document.getElementById(id);
      if (element) element.remove();
    }

    function addPayloadSet() {
      createPayloadSet();
    }

    function loadSniperExample() {
      document.getElementById('strategy').value = 'sniper';
      templateCodeMirror.setValue('GET /hack/normalxss.php?cmd=<<>> HTTP/1.1\nHost: bogus.jp\nUser-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/137.0.0.0 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7\nAccept-Encoding: gzip, deflate, br, zstd\nAccept-Language: ja,en-US;q=0.9,en;q=0.8');
      document.getElementById('placeholders').value = 'cmd,host';
      
      const payloadSets = document.getElementById('payload-sets');
      payloadSets.innerHTML = '';
      codeMirrors = [];
      
      createPayloadSet('sql_injection', '1\n1\' OR \'1\'=\'1\n1; DROP TABLE users; --\n1\' UNION SELECT * FROM users --');
    }

    function loadBatteringRamExample() {
      document.getElementById('strategy').value = 'battering_ram';
      templateCodeMirror.setValue('username=<<username>>&password=<<password>>&email=<<email>>');
      document.getElementById('placeholders').value = 'username,password,email';
      
      const payloadSets = document.getElementById('payload-sets');
      payloadSets.innerHTML = '';
      codeMirrors = [];
      
      createPayloadSet('common_credentials', `admin
test
guest
root`);
    }

    function loadPitchforkExample() {
      document.getElementById('strategy').value = 'pitchfork';
      templateCodeMirror.setValue('username=<<username>>&user_id=<<user_id>>&role=<<role>>');
      document.getElementById('placeholders').value = 'username,user_id,role';
      
      const payloadSets = document.getElementById('payload-sets');
      payloadSets.innerHTML = '';
      codeMirrors = [];
      
      createPayloadSet('usernames', `admin
user1
test
john`);
      
      createPayloadSet('user_ids', `1
2
3
4`);
      
      createPayloadSet('roles', `admin
user
guest
moderator`);
    }

    function loadClusterBombExample() {
      document.getElementById('strategy').value = 'cluster_bomb';
      templateCodeMirror.setValue('username=<<username>>&password=<<password>>');
      document.getElementById('placeholders').value = 'username,password';
      
      const payloadSets = document.getElementById('payload-sets');
      payloadSets.innerHTML = '';
      codeMirrors = [];
      
      createPayloadSet('usernames', `admin
user1
test`);
      
      createPayloadSet('passwords', `password123
123456
qwerty
admin123`);
    }

    function loadPostFormExample() {
      document.getElementById('strategy').value = 'sniper';
      templateCodeMirror.setValue(`POST /api/login HTTP/1.1
Host: example.com
Content-Type: application/x-www-form-urlencoded
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: ja,en-US;q=0.9,en;q=0.8
Accept-Encoding: gzip, deflate, br
Connection: keep-alive
Content-Length: <<>>

username=<<>>&password=<<>>&submit=Login`);
      document.getElementById('placeholders').value = 'content_length,username,password';
      
      const payloadSets = document.getElementById('payload-sets');
      payloadSets.innerHTML = '';
      codeMirrors = [];
      
      createPayloadSet('login_credentials', `admin
user123
testuser`);
    }

    function loadPostJsonExample() {
      document.getElementById('strategy').value = 'sniper';
      templateCodeMirror.setValue(`POST /api/users HTTP/1.1
Host: api.example.com
Content-Type: application/json
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36
Accept: application/json
Authorization: Bearer <<>>
Content-Length: <<>>

{"username": "<<>>", "email": "<<>>", "role": "user"}`);
      document.getElementById('placeholders').value = 'auth_token,content_length,username,email';
      
      const payloadSets = document.getElementById('payload-sets');
      payloadSets.innerHTML = '';
      codeMirrors = [];
      
      createPayloadSet('user_data', `john_doe
jane_smith
admin_user`);
    }

    function loadPostMultipartExample() {
      document.getElementById('strategy').value = 'sniper';
      templateCodeMirror.setValue(`POST /api/upload HTTP/1.1
Host: upload.example.com
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary<<>>
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36
Accept: application/json
Content-Length: <<>>

------WebKitFormBoundary<<>>
Content-Disposition: form-data; name="file"; filename="<<>>"
Content-Type: application/octet-stream

<<>>
------WebKitFormBoundary<<>>
Content-Disposition: form-data; name="description"

<<>>
------WebKitFormBoundary<<>>--`);
      document.getElementById('placeholders').value = 'boundary1,content_length,boundary2,filename,file_content,boundary3,description,boundary4';
      
      const payloadSets = document.getElementById('payload-sets');
      payloadSets.innerHTML = '';
      codeMirrors = [];
      
      createPayloadSet('file_upload', `test.txt
document.pdf
image.jpg`);
    }

    async function sendRequest() {
      const strategy = document.getElementById('strategy').value;
      const template = templateCodeMirror.getValue();
      const placeholders = document.getElementById('placeholders').value.split(',').map(s => s.trim()).filter(Boolean);
      
      const payloadSets = [];
      const payloadSetCards = document.querySelectorAll('.payload-set-card');
      
      payloadSetCards.forEach(card => {
        const name = card.querySelector('input').value;
        const cm = card.querySelector('.CodeMirror');
        const payloads = cm ? cm.CodeMirror.getValue().split('\n').filter(p => p.trim()) : [];
        
        if (name && payloads.length > 0) {
          payloadSets.push({
            name: name,
            payloads: payloads
          });
        }
      });

      const body = { template, placeholders, strategy, payload_sets: payloadSets };

      const button = document.querySelector('.btn-success');
      const spinner = button.querySelector('.loading-spinner');
      button.disabled = true;
      spinner.style.display = 'inline-block';
      
      document.getElementById('result').innerHTML = `
        <div class="text-center">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2">リクエスト送信中...</p>
        </div>
      `;

      try {
        const res = await fetch('/api/replace-placeholders', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        
        const data = await res.json();
        
        if (res.ok) {
          displayResults(data);
        } else {
          displayError(data.detail || 'エラーが発生しました');
        }
      } catch (e) {
        displayError('ネットワークエラー: ' + e.message);
      } finally {
        button.disabled = false;
        spinner.style.display = 'none';
      }
    }

    function displayResults(data) {
      const strategyNames = {
        'sniper': 'Sniper Attack',
        'battering_ram': 'Battering Ram Attack',
        'pitchfork': 'Pitchfork Attack',
        'cluster_bomb': 'Cluster Bomb Attack'
      };

      let html = `
        <div class="mb-3">
          <span class="badge bg-primary strategy-badge">${strategyNames[data.strategy] || data.strategy}</span>
          <span class="badge bg-success strategy-badge">${data.total_requests} リクエスト</span>
        </div>
        <div class="accordion" id="resultsAccordion">
      `;

      data.requests.forEach((request, index) => {
        const accordionId = `accordion-${index}`;
        html += `
          <div class="accordion-item">
            <h2 class="accordion-header" id="heading-${accordionId}">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${accordionId}">
                リクエスト ${index + 1}
              </button>
            </h2>
            <div id="collapse-${accordionId}" class="accordion-collapse collapse" data-bs-parent="#resultsAccordion">
              <div class="accordion-body">
                <div class="mb-2"><strong>生成されたリクエスト:</strong></div>
                <pre class="bg-light p-2 rounded font-monospace small" style="margin-bottom:0;">${escapeHtml(request.request)}</pre>
                ${request.payloads ? `
                  <div class="mt-2">
                    <strong>使用されたペイロード:</strong>
                    <ul class="list-unstyled mt-1">
                      ${Object.entries(request.payloads).map(([key, value]) => 
                        `<li><code>${key}:</code> ${escapeHtml(value)}</li>`
                      ).join('')}
                    </ul>
                  </div>
                ` : ''}
                ${request.placeholder ? `
                  <div class="mt-2">
                    <strong>プレースホルダ:</strong> <code>${request.placeholder}</code><br>
                    <strong>ペイロード:</strong> <code>${escapeHtml(request.payload)}</code>
                  </div>
                ` : ''}
              </div>
            </div>
          </div>
        `;
      });

      html += '</div>';
      document.getElementById('result').innerHTML = html;
    }

    function displayError(message) {
      document.getElementById('result').innerHTML = `
        <div class="alert alert-danger">
          <i class="bi bi-exclamation-triangle"></i>
          <strong>エラー:</strong> ${message}
        </div>
      `;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    window.onload = function() {
      // テンプレートのCodeMirrorを初期化
      const templateTextarea = document.getElementById('template');
      templateCodeMirror = CodeMirror.fromTextArea(templateTextarea, {
        mode: 'text/plain',
        theme: 'monokai',
        lineNumbers: true,
        lineWrapping: true,
        indentUnit: 2,
        tabSize: 2,
        placeholder: '例: GET /api/users?id=<<>> HTTP/1.1'
      });
      
      // CodeMirrorの初期化後に例を読み込み
      setTimeout(() => {
        loadSniperExample();
      }, 100);
    };
  </script>
</body>
</html> 