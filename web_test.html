<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>プレースホルダ置換API - テストページ</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <!-- CodeMirror CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css" rel="stylesheet">
  
  <style>
    body { background-color: #f8f9fa; }
    .navbar-brand { font-weight: bold; }
    .card { box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075); border: none; margin-bottom: 1rem; }
    .card-header { background-color: #fff; border-bottom: 1px solid #dee2e6; font-weight: 600; }
    .btn-example { margin-right: 0.5rem; margin-bottom: 0.5rem; }
    .CodeMirror { height: auto; min-height: 120px; border: 1px solid #dee2e6; border-radius: 0.375rem; }
    .payload-set-card { border-left: 4px solid #007bff; }
    .payload-set-card .card-header { background-color: #f8f9fa; }
    .result-container { max-height: 500px; overflow-y: auto; }
    .strategy-badge { font-size: 0.875rem; }
    .loading-spinner { display: none; }
    .example-section { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem 0; margin-bottom: 2rem; }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
      <a class="navbar-brand" href="#"><i class="bi bi-bug"></i> プレースホルダ置換API</a>
      <div class="navbar-nav ms-auto">
        <a class="nav-link" href="/docs" target="_blank"><i class="bi bi-file-text"></i> API Docs</a>
      </div>
    </div>
  </nav>

  <!-- Example Section -->
  <div class="example-section">
    <div class="container">
      <h2 class="text-center mb-4"><i class="bi bi-lightning"></i> 攻撃戦略テスト</h2>
      <div class="text-center">
        <button class="btn btn-light btn-example" onclick="loadSniperExample()">
          <i class="bi bi-crosshair"></i> Sniper Attack
        </button>
        <button class="btn btn-light btn-example" onclick="loadBatteringRamExample()">
          <i class="bi bi-hammer"></i> Battering Ram Attack
        </button>
        <button class="btn btn-light btn-example" onclick="loadPitchforkExample()">
          <i class="bi bi-three-dots"></i> Pitchfork Attack
        </button>
        <button class="btn btn-light btn-example" onclick="loadClusterBombExample()">
          <i class="bi bi-grid-3x3"></i> Cluster Bomb Attack
        </button>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="row">
      <!-- Configuration Panel -->
      <div class="col-lg-6">
        <div class="card">
          <div class="card-header"><i class="bi bi-gear"></i> 設定</div>
          <div class="card-body">
            <div class="mb-3">
              <label for="strategy" class="form-label">戦略</label>
              <select id="strategy" class="form-select">
                <option value="sniper">Sniper Attack</option>
                <option value="battering_ram">Battering Ram Attack</option>
                <option value="pitchfork">Pitchfork Attack</option>
                <option value="cluster_bomb">Cluster Bomb Attack</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="template" class="form-label">テンプレート</label>
              <textarea id="template" class="form-control" rows="8" placeholder="例: GET /api/users?id=<<>> HTTP/1.1"></textarea>
            </div>
            <div class="mb-3">
              <label for="placeholders" class="form-label">プレースホルダ（カンマ区切り）</label>
              <input id="placeholders" type="text" class="form-control" placeholder="例: id,name">
            </div>
            <div class="mb-3">
              <label class="form-label">例を読み込む:</label>
              <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="loadSniperExample()">Sniper</button>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="loadBatteringRamExample()">Battering Ram</button>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="loadPitchforkExample()">Pitchfork</button>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="loadClusterBombExample()">Cluster Bomb</button>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="loadPostFormExample()">POST Form</button>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="loadPostJsonExample()">POST JSON</button>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="loadPostMultipartExample()">POST Multipart</button>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="loadMutationExample()">Mutation</button>
              </div>
            </div>
          </div>
        </div>

        <!-- JSON入力セクション -->
        <div class="card">
          <div class="card-header">
            <i class="bi bi-file-code"></i> JSON入力（Mutations形式）
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label class="form-label">
                <i class="bi bi-file-code"></i> JSONから読み込み（Mutations形式）
              </label>
              <div class="input-group">
                <textarea id="json-input" class="form-control" rows="6" placeholder='{
  "mutations": [
    {
      "token": "<<X>>",
      "strategy": "dictionary",
      "values": [
        "&lt;script&gt;",
        "\' OR 1=1 --",
        {
          "value": "ABC",
          "repeat": 3000
        }
      ]
    }
  ],
  "combo": "Sniper"
}'></textarea>
                <button class="btn btn-outline-primary" type="button" onclick="loadFromJson()">
                  <i class="bi bi-arrow-down-circle"></i> 読み込み
                </button>
              </div>
              <div class="mt-2">
                <button class="btn btn-sm btn-outline-secondary" onclick="loadSampleJson()">
                  <i class="bi bi-file-earmark-text"></i> Sniperサンプル
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="loadBatteringRamSampleJson()">
                  <i class="bi bi-file-earmark-text"></i> Battering Ramサンプル
                </button>
              </div>
              <div class="form-text">
                Mutations形式のJSONを入力してペイロードを指定できます
              </div>
            </div>
          </div>
        </div>

        <div class="text-center">
          <button class="btn btn-success btn-lg" onclick="sendRequest()">
            <i class="bi bi-play-circle"></i> API実行
            <div class="spinner-border spinner-border-sm loading-spinner" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </button>
        </div>
      </div>

      <!-- Results Panel -->
      <div class="col-lg-6">
        <div class="card">
          <div class="card-header"><i class="bi bi-graph-up"></i> 結果</div>
          <div class="card-body">
            <div id="result" class="result-container">
              <div class="text-center text-muted">
                <i class="bi bi-arrow-right-circle" style="font-size: 2rem;"></i>
                <p>設定を入力して「API実行」をクリックしてください</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- CodeMirror JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>

  <script>
    let codeMirrors = [];
    let templateCodeMirror = null;
    let jsonCodeMirror = null;

    function loadFromJson() {
      const jsonInput = jsonCodeMirror ? jsonCodeMirror.getValue().trim() : document.getElementById('json-input').value.trim();
      
      if (!jsonInput) {
        alert('JSONを入力してください');
        return;
      }
      
      try {
        const data = JSON.parse(jsonInput);
        
        // 戦略を設定（comboフィールドがある場合）
        if (data.combo) {
          const strategyMap = {
            'Sniper': 'sniper',
            'Battering Ram': 'battering_ram',
            'Pitchfork': 'pitchfork',
            'Cluster Bomb': 'cluster_bomb'
          };
          const strategy = strategyMap[data.combo] || 'sniper';
          document.getElementById('strategy').value = strategy;
        }
        
        // mutationsを処理してプレースホルダを設定
        if (data.mutations && Array.isArray(data.mutations)) {
          const placeholders = [];
          data.mutations.forEach((mutation) => {
            if (mutation.token) {
              // トークンをそのままプレースホルダとして使用（<<username>> -> <<username>>）
              if (!placeholders.includes(mutation.token)) {
                placeholders.push(mutation.token);
              }
            }
          });
          
          // プレースホルダフィールドを更新
          document.getElementById('placeholders').value = placeholders.join(', ');
        }
        
        // 成功メッセージ
        alert('JSONから設定を読み込みました！');
        
      } catch (error) {
        alert('JSONの解析に失敗しました: ' + error.message);
      }
    }

    function loadSniperExample() {
      document.getElementById('strategy').value = 'sniper';
      if (templateCodeMirror) {
        templateCodeMirror.setValue('GET /hack/normalxss.php?cmd=<<>> HTTP/1.1\nHost: bogus.jp\nUser-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/137.0.0.0 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7\nAccept-Encoding: gzip, deflate, br, zstd\nAccept-Language: ja,en-US;q=0.9,en;q=0.8');
      } else {
        document.getElementById('template').value = 'GET /hack/normalxss.php?cmd=<<>> HTTP/1.1\nHost: bogus.jp\nUser-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/137.0.0.0 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7\nAccept-Encoding: gzip, deflate, br, zstd\nAccept-Language: ja,en-US;q=0.9,en;q=0.8';
      }
      document.getElementById('placeholders').value = 'cmd,host';
    }

    function loadBatteringRamExample() {
      document.getElementById('strategy').value = 'battering_ram';
      if (templateCodeMirror) {
        templateCodeMirror.setValue('username=<<username>>&password=<<password>>&email=<<email>>');
      } else {
        document.getElementById('template').value = 'username=<<username>>&password=<<password>>&email=<<email>>';
      }
      document.getElementById('placeholders').value = 'username,password,email';
    }

    function loadPitchforkExample() {
      document.getElementById('strategy').value = 'pitchfork';
      if (templateCodeMirror) {
        templateCodeMirror.setValue('username=<<username>>&user_id=<<user_id>>&role=<<role>>');
      } else {
        document.getElementById('template').value = 'username=<<username>>&user_id=<<user_id>>&role=<<role>>';
      }
      document.getElementById('placeholders').value = 'username,user_id,role';
    }

    function loadClusterBombExample() {
      document.getElementById('strategy').value = 'cluster_bomb';
      if (templateCodeMirror) {
        templateCodeMirror.setValue('username=<<username>>&password=<<password>>');
      } else {
        document.getElementById('template').value = 'username=<<username>>&password=<<password>>';
      }
      document.getElementById('placeholders').value = 'username,password';
    }

    function loadPostFormExample() {
      document.getElementById('strategy').value = 'sniper';
      const templateValue = `POST /api/login HTTP/1.1
Host: example.com
Content-Type: application/x-www-form-urlencoded
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: ja,en-US;q=0.9,en;q=0.8
Accept-Encoding: gzip, deflate, br
Connection: keep-alive
Content-Length: <<>>

username=<<>>&password=<<>>&submit=Login`;
      
      if (templateCodeMirror) {
        templateCodeMirror.setValue(templateValue);
      } else {
        document.getElementById('template').value = templateValue;
      }
      document.getElementById('placeholders').value = 'content_length,username,password';
    }

    function loadPostJsonExample() {
      document.getElementById('strategy').value = 'sniper';
      const templateValue = `POST /api/users HTTP/1.1
Host: api.example.com
Content-Type: application/json
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36
Accept: application/json
Authorization: Bearer <<>>
Content-Length: <<>>

{"username": "<<>>", "email": "<<>>", "role": "user"}`;
      
      if (templateCodeMirror) {
        templateCodeMirror.setValue(templateValue);
      } else {
        document.getElementById('template').value = templateValue;
      }
      document.getElementById('placeholders').value = 'auth_token,content_length,username,email';
    }

    function loadPostMultipartExample() {
      document.getElementById('strategy').value = 'sniper';
      const templateValue = `POST /api/upload HTTP/1.1
Host: upload.example.com
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary<<>>
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36
Accept: application/json
Content-Length: <<>>

------WebKitFormBoundary<<>>
Content-Disposition: form-data; name="file"; filename="<<>>"
Content-Type: application/octet-stream

<<>>
------WebKitFormBoundary<<>>
Content-Disposition: form-data; name="description"

<<>>
------WebKitFormBoundary<<>>--`;
      
      if (templateCodeMirror) {
        templateCodeMirror.setValue(templateValue);
      } else {
        document.getElementById('template').value = templateValue;
      }
      document.getElementById('placeholders').value = 'boundary1,content_length,boundary2,filename,file_content,boundary3,description,boundary4';
    }

    function loadMutationExample() {
      // 戦略をmutationに設定
      document.getElementById('strategy').value = 'mutation';
      
      // テンプレートを設定
      const templateValue = `GET /api/test?param=<<X>> HTTP/1.1
Host: example.com
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8`;
      
      if (templateCodeMirror) {
        templateCodeMirror.setValue(templateValue);
      } else {
        document.getElementById('template').value = templateValue;
      }
      
      // プレースホルダを設定
      document.getElementById('placeholders').value = 'X';
      
      // ペイロードセットをクリア
      const payloadSets = document.getElementById('payload-sets');
      payloadSets.innerHTML = '';
      codeMirrors = [];
      
      // 変異の例を設定（実際のAPIでは別のエンドポイントを使用）
      alert('Mutation機能の例:\n\n' +
            '{\n' +
            '  "template": "GET /api/test?param=<<X>> HTTP/1.1\\nHost: example.com",\n' +
            '  "mutations": [\n' +
            '    {\n' +
            '      "token": "<<X>>",\n' +
            '      "strategy": "dictionary",\n' +
            '      "values": [\n' +
            '        "<script>alert(\\"XSS\\")<\/script>",\n' +
            '        "\' OR 1=1 --",\n' +
            '        {\n' +
            '          "value": "A",\n' +
            '          "repeat": 1000\n' +
            '        }\n' +
            '      ]\n' +
            '    }\n' +
            '  ]\n' +
            '}\n\n' +
            'この機能は /api/mutations エンドポイントで利用できます。');
    }

    function loadSampleJson() {
      const sampleJson = [
        '{',
        '  "mutations": [',
        '    {',
        '      "token": "<<X>>",',
        '      "strategy": "dictionary",',
        '      "values": [',
        '        "<script>alert(\\"XSS\\")<\/script>",',
        '        "\' OR 1=1 --",',
        '        { "value": "A", "repeat": 3000 }',
        '      ]',
        '    }',
        '  ],',
        '  "combo": "Sniper"',
        '}'
      ].join('\n');
      if (jsonCodeMirror) {
        jsonCodeMirror.setValue(sampleJson);
      } else {
        document.getElementById('json-input').value = sampleJson;
      }
    }

    function loadBatteringRamSampleJson() {
      const sampleJson = [
        '{',
        '  "mutations": [',
        '    {',
        '      "token": "<<username>>",',
        '      "strategy": "dictionary",',
        '      "values": [',
        '        "admin",',
        '        "test",',
        '        "guest",',
        '        "root"',
        '      ]',
        '    },',
        '    {',
        '      "token": "<<password>>",',
        '      "strategy": "dictionary",',
        '      "values": [',
        '        "admin",',
        '        "test",',
        '        "guest",',
        '        "root"',
        '      ]',
        '    },',
        '    {',
        '      "token": "<<email>>",',
        '      "strategy": "dictionary",',
        '      "values": [',
        '        "admin@example.com",',
        '        "test@example.com",',
        '        "guest@example.com",',
        '        "root@example.com"',
        '      ]',
        '    }',
        '  ],',
        '  "combo": "Battering Ram"',
        '}'
      ].join('\n');
      if (jsonCodeMirror) {
        jsonCodeMirror.setValue(sampleJson);
      } else {
        document.getElementById('json-input').value = sampleJson;
      }
    }

    async function sendRequest() {
      const strategy = document.getElementById('strategy').value;
      const template = templateCodeMirror ? templateCodeMirror.getValue() : document.getElementById('template').value;
      const placeholders = document.getElementById('placeholders').value.split(',').map(s => s.trim()).filter(Boolean);
      
      // JSON入力からmutationsデータを取得
      const jsonInput = jsonCodeMirror ? jsonCodeMirror.getValue().trim() : document.getElementById('json-input').value.trim();
      
      if (!jsonInput) {
        alert('JSONを入力してください');
        return;
      }
      
      let payloadSets = [];
      
      try {
        const data = JSON.parse(jsonInput);
        
        // mutationsデータをペイロードセット形式に変換
        if (data.mutations && Array.isArray(data.mutations)) {
          data.mutations.forEach((mutation) => {
            if (mutation.token && mutation.values && Array.isArray(mutation.values)) {
              const payloads = mutation.values.map(value => {
                if (typeof value === 'string') {
                  return value;
                } else if (typeof value === 'object' && value.value && value.repeat) {
                  // repeat機能の場合は実際の値を展開
                  return value.value.repeat(value.repeat);
                }
                return JSON.stringify(value);
              }).filter(p => p.trim());
              
              if (payloads.length > 0) {
                payloadSets.push({
                  name: mutation.token,
                  payloads: payloads
                });
              }
            }
          });
        }
      } catch (error) {
        alert('JSONの解析に失敗しました: ' + error.message);
        return;
      }

      const body = { template, placeholders, strategy, payload_sets: payloadSets };

      const button = document.querySelector('.btn-success');
      const spinner = button.querySelector('.loading-spinner');
      button.disabled = true;
      spinner.style.display = 'inline-block';
      
      document.getElementById('result').innerHTML = `
        <div class="text-center">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2">リクエスト送信中...</p>
        </div>
      `;

      try {
        // 新しい直感的なAPIエンドポイントを使用
        const intuitiveBody = {
          template: template,
          strategy: strategy,
          payload_sets: payloadSets.map(payloadSet => ({
            token: payloadSet.name,
            strategy: "dictionary", // デフォルト戦略
            values: payloadSet.payloads
          }))
        };
        
        const response = await fetch('/api/intuitive', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(intuitiveBody)
        });

        const result = await response.json();
        
        if (response.ok) {
          displayResults(result);
        } else {
          document.getElementById('result').innerHTML = `
            <div class="alert alert-danger">
              <h5><i class="bi bi-exclamation-triangle"></i> エラー</h5>
              <p>${result.detail || 'リクエストに失敗しました'}</p>
            </div>
          `;
        }
      } catch (error) {
        document.getElementById('result').innerHTML = `
          <div class="alert alert-danger">
            <h5><i class="bi bi-exclamation-triangle"></i> エラー</h5>
            <p>ネットワークエラー: ${error.message}</p>
          </div>
        `;
      } finally {
        button.disabled = false;
        spinner.style.display = 'none';
      }
    }

    function displayResults(result) {
      const resultDiv = document.getElementById('result');
      
      if (!result.requests || result.requests.length === 0) {
        resultDiv.innerHTML = `
          <div class="alert alert-warning">
            <h5><i class="bi bi-exclamation-triangle"></i> 警告</h5>
            <p>生成されたリクエストがありません</p>
          </div>
        `;
        return;
      }

      let html = `
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5><i class="bi bi-check-circle text-success"></i> 成功</h5>
          <span class="badge bg-primary">${result.requests.length} リクエスト生成</span>
        </div>
        <div class="accordion" id="resultsAccordion">
      `;

      result.requests.forEach((request, index) => {
        const accordionId = `accordion-${index}`;
        const collapseId = `collapse-${index}`;
        const isFirst = index === 0;
        
        html += `
          <div class="accordion-item">
            <h2 class="accordion-header" id="${accordionId}">
              <button class="accordion-button ${isFirst ? '' : 'collapsed'}" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="${isFirst ? 'true' : 'false'}" aria-controls="${collapseId}">
                <i class="bi bi-file-text me-2"></i> リクエスト ${index + 1}
                ${request.strategy ? `<span class="badge bg-secondary strategy-badge ms-auto">${request.strategy}</span>` : ''}
              </button>
            </h2>
            <div id="${collapseId}" class="accordion-collapse collapse ${isFirst ? 'show' : ''}" aria-labelledby="${accordionId}" data-bs-parent="#resultsAccordion">
              <div class="accordion-body">
                <pre class="mb-0" style="white-space: pre-wrap; word-break: break-all;">${escapeHtml(request.request)}</pre>
              </div>
            </div>
          </div>
        `;
      });

      html += '</div>';
      resultDiv.innerHTML = html;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // 初期化処理
    document.addEventListener('DOMContentLoaded', function() {
      // CodeMirrorの初期化
      templateCodeMirror = CodeMirror.fromTextArea(document.getElementById('template'), {
        mode: 'text/plain',
        theme: 'monokai',
        lineNumbers: true,
        lineWrapping: true,
        indentUnit: 2,
        tabSize: 2,
        extraKeys: {
          'Tab': function(cm) {
            cm.replaceSelection('  ', 'end');
          }
        }
      });

      jsonCodeMirror = CodeMirror.fromTextArea(document.getElementById('json-input'), {
        mode: 'application/json',
        theme: 'monokai',
        lineNumbers: true,
        lineWrapping: true,
        indentUnit: 2,
        tabSize: 2,
        extraKeys: {
          'Tab': function(cm) {
            cm.replaceSelection('  ', 'end');
          }
        }
      });

      // デフォルトのSniperサンプルを読み込み
      loadSampleJson();
      
      // デフォルトのテンプレートも読み込み
      loadSniperExample();
    });
  </script>
</body>
</html>