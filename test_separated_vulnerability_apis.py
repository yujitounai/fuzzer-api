#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
åˆ†é›¢ã•ã‚ŒãŸè„†å¼±æ€§åˆ†æAPI ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ

æ–°ã—ãåˆ†é›¢ã•ã‚ŒãŸ3ã¤ã®è„†å¼±æ€§åˆ†æAPIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ï¼š
1. ã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œå‡ºAPI
2. ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰åå°„æ¤œå‡ºAPI  
3. æ™‚é–“é…å»¶æ¤œå‡ºAPI

ä½¿ç”¨æ–¹æ³•:
    python test_separated_vulnerability_apis.py

æ©Ÿèƒ½:
    - èªè¨¼ã¨ã‚¸ãƒ§ãƒ–å®Ÿè¡Œ
    - åŒ…æ‹¬çš„ãªæ”»æ’ƒãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆ
    - 3ã¤ã®åˆ†æAPIã®è©³ç´°ãƒ†ã‚¹ãƒˆ
    - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆ
    - çµæœã®è©³ç´°åˆ†æã¨è¡¨ç¤º
"""

import requests
import time
import json
from typing import Optional, Dict, Any

# è¨­å®š
BASE_URL = "http://localhost:8000"
LOGIN_URL = f"{BASE_URL}/api/auth/login"
USERNAME = "admin"
PASSWORD = "admin123"

def login():
    """
    APIã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
    
    Returns:
        str: ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³
    """
    login_data = {
        "username": USERNAME,
        "password": PASSWORD
    }
    
    response = requests.post(LOGIN_URL, json=login_data)
    if response.status_code == 200:
        token_data = response.json()
        return token_data["access_token"]
    else:
        print(f"ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: {response.status_code} - {response.text}")
        return None

def create_comprehensive_test_requests(token):
    """
    åŒ…æ‹¬çš„ãªãƒ†ã‚¹ãƒˆç”¨ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç”Ÿæˆ
    
    Args:
        token: èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³
        
    Returns:
        int: ãƒªã‚¯ã‚¨ã‚¹ãƒˆID
    """
    headers = {"Authorization": f"Bearer {token}"}
    
    # ã‚ˆã‚ŠåŒ…æ‹¬çš„ãªæ”»æ’ƒãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚»ãƒƒãƒˆ
    request_data = {
        "template": "GET /get?q=<<X>>&type=<<Y>> HTTP/1.1\\r\\nHost: target.com\\r\\n\\r\\n",
        "placeholders": ["X", "Y"],
        "strategy": "cluster_bomb",
        "payload_sets": [
            {
                "name": "comprehensive_attacks",
                "payloads": [
                    # SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³
                    "'",
                    "1' OR '1'='1",
                    "'; DROP TABLE users; --",
                    "1'; WAITFOR DELAY '00:00:03'--",
                    "1' AND (SELECT COUNT(*) FROM sysobjects)>0--",
                    
                    # XSSæ”»æ’ƒ
                    "<script>alert('XSS')</script>",
                    "<img src=x onerror=alert('XSS2')>",
                    "javascript:alert('XSS3')",
                    "<svg onload=alert('XSS4')>",
                    "'\"><script>alert('XSS5')</script>",
                    
                    # ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³
                    "{{7*7}}",
                    "${7*7}",
                    "#{7*7}",
                    
                    # ãƒ‘ã‚¹ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«
                    "../../../../etc/passwd",
                    "..\\..\\..\\windows\\system32\\drivers\\etc\\hosts",
                    
                    # ã‚³ãƒãƒ³ãƒ‰ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³
                    "; ls -la",
                    "| whoami",
                    "& ipconfig",
                    
                    # é€šå¸¸ã®ã‚¯ã‚¨ãƒªï¼ˆæ¯”è¼ƒç”¨ï¼‰
                    "normal_query",
                    "test_search"
                ]
            },
            {
                "name": "search_types",
                "payloads": [
                    "user",
                    "admin", 
                    "product",
                    "system",
                    "config"
                ]
            }
        ]
    }
    
    response = requests.post(
        f"{BASE_URL}/api/replace-placeholders",
        json=request_data,
        headers=headers
    )
    
    if response.status_code == 200:
        result = response.json()
        print(f"âœ… ãƒªã‚¯ã‚¨ã‚¹ãƒˆç”ŸæˆæˆåŠŸ: ID={result['request_id']}, ç·æ•°={result['total_requests']}")
        return result["request_id"]
    else:
        print(f"ãƒªã‚¯ã‚¨ã‚¹ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼: {response.status_code} - {response.text}")
        return None

def execute_requests_with_delay(request_id, token):
    """
    ç”Ÿæˆã•ã‚ŒãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å®Ÿè¡Œï¼ˆæ™‚é–“é…å»¶æ¤œå‡ºã®ãŸã‚æ„å›³çš„ã«é…å»¶ã‚’è¿½åŠ ï¼‰
    
    Args:
        request_id: ãƒªã‚¯ã‚¨ã‚¹ãƒˆID
        token: èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³
        
    Returns:
        str: ã‚¸ãƒ§ãƒ–ID
    """
    headers = {"Authorization": f"Bearer {token}"}
    
    execute_data = {
        "request_id": request_id,
        "http_config": {
            "timeout": 30,
            "follow_redirects": True,
            "verify_ssl": False,
            "scheme": "http",
            "base_url": "httpbin.org",
            "sequential_execution": True,
            "request_delay": 0.5  # æ„å›³çš„ãªé…å»¶ã§æ™‚é–“é…å»¶åˆ†æã‚’ãƒ†ã‚¹ãƒˆ
        }
    }
    
    response = requests.post(
        f"{BASE_URL}/api/execute-requests",
        json=execute_data,
        headers=headers
    )
    
    if response.status_code == 200:
        job_data = response.json()
        job_id = job_data["job_id"]
        print(f"âœ… ã‚¸ãƒ§ãƒ–é–‹å§‹: {job_id}")
        return job_id
    else:
        print(f"å®Ÿè¡Œã‚¨ãƒ©ãƒ¼: {response.status_code} - {response.text}")
        return None

def wait_for_job_completion(job_id, token, max_wait_time=180):
    """
    ã‚¸ãƒ§ãƒ–ã®å®Œäº†ã‚’å¾…æ©Ÿ
    
    Args:
        job_id: ã‚¸ãƒ§ãƒ–ID
        token: èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³
        max_wait_time: æœ€å¤§å¾…æ©Ÿæ™‚é–“ï¼ˆç§’ï¼‰
        
    Returns:
        bool: å®Œäº†ã—ãŸã‹ã©ã†ã‹
    """
    headers = {"Authorization": f"Bearer {token}"}
    start_time = time.time()
    last_progress = 0
    
    while time.time() - start_time < max_wait_time:
        response = requests.get(
            f"{BASE_URL}/api/jobs/{job_id}",
            headers=headers
        )
        
        if response.status_code == 200:
            job_data = response.json()
            status = job_data["status"]
            progress = job_data.get("progress", {})
            
            # é€²æ—è¡¨ç¤ºã®æ”¹å–„
            current_progress = progress.get("progress_percentage", 0)
            if current_progress != last_progress:
                print(f"é€²æ—: {current_progress:.1f}% ({progress.get('completed_requests', 0)}/{progress.get('total_requests', 0)})")
                last_progress = current_progress
            
            if status == "completed":
                print("âœ… ã‚¸ãƒ§ãƒ–å®Œäº†")
                return True
            elif status == "failed":
                print(f"âŒ ã‚¸ãƒ§ãƒ–å¤±æ•—: {job_data.get('error_message', 'Unknown error')}")
                return False
        
        time.sleep(0.5)
    
    print("âŒ ã‚¸ãƒ§ãƒ–å®Œäº†å¾…æ©ŸãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ")
    return False

def test_error_pattern_analysis(job_id, token):
    """
    ã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æAPIã®ãƒ†ã‚¹ãƒˆ
    
    Args:
        job_id: ã‚¸ãƒ§ãƒ–ID
        token: èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³
    """
    print("\\n" + "="*50)
    print("ğŸ” ã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æãƒ†ã‚¹ãƒˆ")
    print("="*50)
    headers = {"Authorization": f"Bearer {token}"}
    
    # POSTãƒ¡ã‚½ãƒƒãƒ‰ã§ã®ãƒ†ã‚¹ãƒˆï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šï¼‰
    print("\\n1. POSTåˆ†æï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šï¼‰:")
    response = requests.post(
        f"{BASE_URL}/api/jobs/{job_id}/analyze/error-patterns",
        headers=headers
    )
    
    if response.status_code == 200:
        result = response.json()
        print(f"âœ… åˆ†ææˆåŠŸ:")
        print(f"  ğŸ“Š ç·ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°: {result['total_requests']}")
        print(f"  ğŸ“Š åˆ†ææ¸ˆã¿æ•°: {result['analyzed_requests']}")
        print(f"  ğŸ“Š ã‚¨ãƒ©ãƒ¼æ¤œå‡ºæ•°: {result['error_findings_count']}")
        print(f"  ğŸ“Š ãƒã‚§ãƒƒã‚¯ãƒ‘ã‚¿ãƒ¼ãƒ³æ•°: {len(result['patterns_checked'])}")
        
        if result['findings']:
            print(f"\\nğŸš¨ æ¤œå‡ºã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ (æœ€åˆã®5ä»¶):")
            for i, finding in enumerate(result['findings'][:5], 1):
                print(f"  {i}. ãƒªã‚¯ã‚¨ã‚¹ãƒˆ{finding['request_number']}: {finding['error_pattern']}")
                print(f"     æ·±åˆ»åº¦: {finding['severity']}")
                print(f"     ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰: {finding.get('payload', 'N/A')}")
                if finding.get('response_snippet'):
                    snippet = finding['response_snippet'][:100] + "..." if len(finding['response_snippet']) > 100 else finding['response_snippet']
                    print(f"     è¨¼æ‹ : {snippet}")
                print()
        else:
            print("  â„¹ï¸ ã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸï¼ˆæ­£å¸¸ï¼‰")
    else:
        print(f"âŒ ã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æã‚¨ãƒ©ãƒ¼: {response.status_code} - {response.text}")
    
    # POSTãƒ¡ã‚½ãƒƒãƒ‰ã§ã®ãƒ†ã‚¹ãƒˆï¼ˆã‚«ã‚¹ã‚¿ãƒ è¨­å®šï¼‰
    print("\\n2. POSTåˆ†æï¼ˆã‚«ã‚¹ã‚¿ãƒ è¨­å®š - é«˜ç²¾åº¦ï¼‰:")
    custom_config = {
        "error_patterns": [
            "sql error", "database error", "mysql", "postgresql", "oracle",
            "stack trace", "exception", "internal server error",
            "access denied", "permission denied", "401", "403", "500"
        ],
        "case_sensitive": False
    }
    
    response = requests.post(
        f"{BASE_URL}/api/jobs/{job_id}/analyze/error-patterns",
        headers=headers,
        json=custom_config
    )
    
    if response.status_code == 200:
        result = response.json()
        print(f"âœ… ã‚«ã‚¹ã‚¿ãƒ è¨­å®šã§ã®æ¤œå‡ºæ•°: {result['error_findings_count']}")
        if result['error_findings_count'] > 0:
            print("  ğŸ¯ ã‚«ã‚¹ã‚¿ãƒ ãƒ‘ã‚¿ãƒ¼ãƒ³ã§è¿½åŠ æ¤œå‡ºã‚ã‚Š")
    else:
        print(f"âŒ ã‚«ã‚¹ã‚¿ãƒ è¨­å®šã‚¨ãƒ©ãƒ¼: {response.status_code}")
    
    # GETãƒ¡ã‚½ãƒƒãƒ‰ã§ã®ãƒ†ã‚¹ãƒˆ
    print("\\n3. GETåˆ†æï¼ˆã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼‰:")
    patterns_query = "sql error,database error,exception,stack trace"
    response = requests.get(
        f"{BASE_URL}/api/jobs/{job_id}/analyze/error-patterns?error_patterns={patterns_query}&case_sensitive=false",
        headers=headers
    )
    
    if response.status_code == 200:
        result = response.json()
        print(f"âœ… GETãƒ¡ã‚½ãƒƒãƒ‰ã§ã®æ¤œå‡ºæ•°: {result['error_findings_count']}")
    else:
        print(f"âŒ GETã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æã‚¨ãƒ©ãƒ¼: {response.status_code}")

def test_payload_reflection_analysis(job_id, token):
    """
    ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰åå°„åˆ†æAPIã®ãƒ†ã‚¹ãƒˆ
    
    Args:
        job_id: ã‚¸ãƒ§ãƒ–ID
        token: èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³
    """
    print("\\n" + "="*50)
    print("ğŸ”„ ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰åå°„åˆ†æãƒ†ã‚¹ãƒˆ")
    print("="*50)
    headers = {"Authorization": f"Bearer {token}"}
    
    # POSTãƒ¡ã‚½ãƒƒãƒ‰ã§ã®ãƒ†ã‚¹ãƒˆï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šï¼‰
    print("\\n1. POSTåˆ†æï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šï¼‰:")
    response = requests.post(
        f"{BASE_URL}/api/jobs/{job_id}/analyze/payload-reflection",
        headers=headers
    )
    
    if response.status_code == 200:
        result = response.json()
        print(f"âœ… åˆ†ææˆåŠŸ:")
        print(f"  ğŸ“Š ç·ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°: {result['total_requests']}")
        print(f"  ğŸ“Š åˆ†ææ¸ˆã¿æ•°: {result['analyzed_requests']}")
        print(f"  ğŸ“Š åå°„æ¤œå‡ºæ•°: {result['reflection_findings_count']}")
        
        # ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çµ±è¨ˆã®è©³ç´°è¡¨ç¤º
        encoding_summary = result['encoding_summary']
        total_checked = sum(encoding_summary.values())
        if total_checked > 0:
            print(f"\\nğŸ“ˆ ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çµ±è¨ˆ:")
            print(f"  ğŸ”’ é©åˆ‡ã«ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰æ¸ˆã¿: {encoding_summary['encoded']} ({encoding_summary['encoded']/total_checked*100:.1f}%)")
            print(f"  âš ï¸ ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ãªã—: {encoding_summary['not_encoded']} ({encoding_summary['not_encoded']/total_checked*100:.1f}%)")
            print(f"  ğŸ”¶ éƒ¨åˆ†ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰: {encoding_summary['partial']} ({encoding_summary['partial']/total_checked*100:.1f}%)")
        
        if result['findings']:
            print(f"\\nğŸš¨ æ¤œå‡ºã•ã‚ŒãŸãƒšã‚¤ãƒ­ãƒ¼ãƒ‰åå°„ (æœ€åˆã®5ä»¶):")
            for i, finding in enumerate(result['findings'][:5], 1):
                print(f"  {i}. ãƒªã‚¯ã‚¨ã‚¹ãƒˆ{finding['request_number']}: {finding['vulnerability_type']}")
                print(f"     æ·±åˆ»åº¦: {finding['severity']}")
                print(f"     ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰: {finding['payload']}")
                print(f"     ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ³: {finding['encoding_status']}")
                if finding.get('response_snippet'):
                    snippet = finding['response_snippet'][:100] + "..." if len(finding['response_snippet']) > 100 else finding['response_snippet']
                    print(f"     è¨¼æ‹ : {snippet}")
                print()
        else:
            print("  â„¹ï¸ å±é™ºãªåå°„ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸï¼ˆæ­£å¸¸ï¼‰")
    else:
        print(f"âŒ ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰åå°„åˆ†æã‚¨ãƒ©ãƒ¼: {response.status_code} - {response.text}")
    
    # POSTãƒ¡ã‚½ãƒƒãƒ‰ã§ã®ãƒ†ã‚¹ãƒˆï¼ˆé«˜ç²¾åº¦è¨­å®šï¼‰
    print("\\n2. POSTåˆ†æï¼ˆé«˜ç²¾åº¦è¨­å®šï¼‰:")
    high_precision_config = {
        "check_html_encoding": True,
        "check_url_encoding": True,
        "check_js_encoding": True,
        "minimum_payload_length": 2  # ã‚ˆã‚ŠçŸ­ã„ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚‚æ¤œå‡º
    }
    
    response = requests.post(
        f"{BASE_URL}/api/jobs/{job_id}/analyze/payload-reflection",
        headers=headers,
        json=high_precision_config
    )
    
    if response.status_code == 200:
        result = response.json()
        print(f"âœ… é«˜ç²¾åº¦è¨­å®šã§ã®æ¤œå‡ºæ•°: {result['reflection_findings_count']}")
    else:
        print(f"âŒ é«˜ç²¾åº¦è¨­å®šã‚¨ãƒ©ãƒ¼: {response.status_code}")
    
    # GETãƒ¡ã‚½ãƒƒãƒ‰ã§ã®ãƒ†ã‚¹ãƒˆ
    print("\\n3. GETåˆ†æï¼ˆHTMLã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°å°‚ç”¨ï¼‰:")
    response = requests.get(
        f"{BASE_URL}/api/jobs/{job_id}/analyze/payload-reflection?check_html_encoding=true&check_url_encoding=false&minimum_payload_length=3",
        headers=headers
    )
    
    if response.status_code == 200:
        result = response.json()
        print(f"âœ… HTMLã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°å°‚ç”¨æ¤œå‡ºæ•°: {result['reflection_findings_count']}")
    else:
        print(f"âŒ GETãƒšã‚¤ãƒ­ãƒ¼ãƒ‰åå°„åˆ†æã‚¨ãƒ©ãƒ¼: {response.status_code}")

def test_time_delay_analysis(job_id, token):
    """
    æ™‚é–“é…å»¶åˆ†æAPIã®ãƒ†ã‚¹ãƒˆ
    
    Args:
        job_id: ã‚¸ãƒ§ãƒ–ID
        token: èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³
    """
    print("\\n" + "="*50)
    print("â±ï¸ æ™‚é–“é…å»¶åˆ†æãƒ†ã‚¹ãƒˆ")
    print("="*50)
    headers = {"Authorization": f"Bearer {token}"}
    
    # POSTãƒ¡ã‚½ãƒƒãƒ‰ã§ã®ãƒ†ã‚¹ãƒˆï¼ˆä½ã„é–¾å€¤è¨­å®šï¼‰
    print("\\n1. POSTåˆ†æï¼ˆä½ã„é–¾å€¤è¨­å®šï¼‰:")
    low_threshold_config = {
        "time_threshold": 1.0,  # 1ç§’é–¾å€¤ã§ã‚ˆã‚Šå¤šãã®é…å»¶ã‚’æ¤œå‡º
        "baseline_method": "first_request",
        "consider_payload_type": True
    }
    
    response = requests.post(
        f"{BASE_URL}/api/jobs/{job_id}/analyze/time-delay",
        headers=headers,
        json=low_threshold_config
    )
    
    if response.status_code == 200:
        result = response.json()
        print(f"âœ… åˆ†ææˆåŠŸ:")
        print(f"  ğŸ“Š ç·ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°: {result['total_requests']}")
        print(f"  ğŸ“Š åˆ†ææ¸ˆã¿æ•°: {result['analyzed_requests']}")
        print(f"  ğŸ“Š é…å»¶æ¤œå‡ºæ•°: {result['delay_findings_count']}")
        print(f"  ğŸ“Š ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³æ™‚é–“: {result['baseline_response_time']:.3f}ç§’")
        print(f"  ğŸ“Š å¹³å‡ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“: {result['average_response_time']:.3f}ç§’")
        print(f"  ğŸ“Š ä½¿ç”¨é–¾å€¤: {result['threshold_used']:.1f}ç§’")
        
        if result['findings']:
            print(f"\\nğŸš¨ æ¤œå‡ºã•ã‚ŒãŸæ™‚é–“é…å»¶ (æœ€åˆã®3ä»¶):")
            for i, finding in enumerate(result['findings'][:3], 1):
                print(f"  {i}. ãƒªã‚¯ã‚¨ã‚¹ãƒˆ{finding['request_number']}: {finding['vulnerability_type']}")
                print(f"     æ·±åˆ»åº¦: {finding['severity']}")
                print(f"     ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰: {finding.get('payload', 'N/A')}")
                print(f"     ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“: {finding['response_time']:.3f}ç§’")
                print(f"     ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³: {finding['baseline_time']:.3f}ç§’")
                print(f"     é…å»¶é‡: {finding['delay_amount']:.3f}ç§’")
                print()
        else:
            print("  â„¹ï¸ æœ‰æ„ãªæ™‚é–“é…å»¶ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ")
    else:
        print(f"âŒ æ™‚é–“é…å»¶åˆ†æã‚¨ãƒ©ãƒ¼: {response.status_code} - {response.text}")
    
    # POSTãƒ¡ã‚½ãƒƒãƒ‰ã§ã®ãƒ†ã‚¹ãƒˆï¼ˆé«˜ã„é–¾å€¤è¨­å®šï¼‰
    print("\\n2. POSTåˆ†æï¼ˆé«˜ã„é–¾å€¤è¨­å®šï¼‰:")
    high_threshold_config = {
        "time_threshold": 3.0,  # 3ç§’é–¾å€¤ã§é‡è¦ãªé…å»¶ã®ã¿
        "baseline_method": "average",
        "consider_payload_type": True
    }
    
    response = requests.post(
        f"{BASE_URL}/api/jobs/{job_id}/analyze/time-delay",
        headers=headers,
        json=high_threshold_config
    )
    
    if response.status_code == 200:
        result = response.json()
        print(f"âœ… é«˜é–¾å€¤è¨­å®šã§ã®æ¤œå‡ºæ•°: {result['delay_findings_count']}")
        if result['delay_findings_count'] > 0:
            print("  âš ï¸ é‡å¤§ãªé…å»¶ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ")
    else:
        print(f"âŒ é«˜é–¾å€¤è¨­å®šã‚¨ãƒ©ãƒ¼: {response.status_code}")
    
    # GETãƒ¡ã‚½ãƒƒãƒ‰ã§ã®ãƒ†ã‚¹ãƒˆï¼ˆä¸­å¤®å€¤ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ï¼‰
    print("\\n3. GETåˆ†æï¼ˆä¸­å¤®å€¤ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ï¼‰:")
    response = requests.get(
        f"{BASE_URL}/api/jobs/{job_id}/analyze/time-delay?time_threshold=2.0&baseline_method=median&consider_payload_type=false",
        headers=headers
    )
    
    if response.status_code == 200:
        result = response.json()
        print(f"âœ… ä¸­å¤®å€¤ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã§ã®æ¤œå‡ºæ•°: {result['delay_findings_count']}")
        print(f"  ğŸ“Š ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³æ™‚é–“: {result['baseline_response_time']:.3f}ç§’")
    else:
        print(f"âŒ GETæ™‚é–“é…å»¶åˆ†æã‚¨ãƒ©ãƒ¼: {response.status_code}")

def test_error_cases(job_id, token):
    """
    ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ã®ãƒ†ã‚¹ãƒˆ
    
    Args:
        job_id: ã‚¸ãƒ§ãƒ–ID
        token: èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³
    """
    print("\\n" + "="*50)
    print("ğŸ§ª ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆ")
    print("="*50)
    headers = {"Authorization": f"Bearer {token}"}
    
    # å­˜åœ¨ã—ãªã„ã‚¸ãƒ§ãƒ–IDã§ã®ãƒ†ã‚¹ãƒˆ
    print("\\n1. å­˜åœ¨ã—ãªã„ã‚¸ãƒ§ãƒ–IDãƒ†ã‚¹ãƒˆ:")
    fake_job_id = "nonexistent-job-12345"
    response = requests.post(
        f"{BASE_URL}/api/jobs/{fake_job_id}/analyze/error-patterns",
        headers=headers
    )
    
    if response.status_code == 404:
        print("âœ… å­˜åœ¨ã—ãªã„ã‚¸ãƒ§ãƒ–IDã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°: æ­£å¸¸")
    else:
        print(f"âŒ æœŸå¾…ã•ã‚Œã‚‹ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ 404, å®Ÿéš›: {response.status_code}")
    
    # ä¸æ­£ãªè¨­å®šã§ã®ãƒ†ã‚¹ãƒˆ
    print("\\n2. ä¸æ­£ãªè¨­å®šãƒ†ã‚¹ãƒˆ:")
    invalid_config = {
        "time_threshold": -1,  # ä¸æ­£ãªé–¾å€¤
        "baseline_method": "invalid_method"  # ä¸æ­£ãªãƒ¡ã‚½ãƒƒãƒ‰
    }
    
    response = requests.post(
        f"{BASE_URL}/api/jobs/{job_id}/analyze/time-delay",
        headers=headers,
        json=invalid_config
    )
    
    if response.status_code in [400, 422]:
        print("âœ… ä¸æ­£ãªè¨­å®šã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°: æ­£å¸¸")
    else:
        print(f"âŒ æœŸå¾…ã•ã‚Œã‚‹ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ 400/422, å®Ÿéš›: {response.status_code}")
    
    # èªè¨¼ãªã—ã§ã®ãƒ†ã‚¹ãƒˆ
    print("\\n3. èªè¨¼ãªã—ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆ:")
    response = requests.post(
        f"{BASE_URL}/api/jobs/{job_id}/analyze/error-patterns"
    )
    
    if response.status_code == 401:
        print("âœ… èªè¨¼ãªã—ã‚¢ã‚¯ã‚»ã‚¹ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°: æ­£å¸¸")
    else:
        print(f"âŒ æœŸå¾…ã•ã‚Œã‚‹ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ 401, å®Ÿéš›: {response.status_code}")

def print_comprehensive_summary(results):
    """
    åŒ…æ‹¬çš„ãªçµæœã‚µãƒãƒªãƒ¼ã‚’è¡¨ç¤º
    
    Args:
        results: ãƒ†ã‚¹ãƒˆçµæœè¾æ›¸
    """
    print("\\n" + "="*60)
    print("ğŸ“Š åŒ…æ‹¬çš„ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼")
    print("="*60)
    
    print(f"ğŸ” ã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æ:")
    print(f"  ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š: {'âœ…' if results.get('error_default') else 'âŒ'}")
    print(f"  ã‚«ã‚¹ã‚¿ãƒ è¨­å®š: {'âœ…' if results.get('error_custom') else 'âŒ'}")
    print(f"  GETãƒ¡ã‚½ãƒƒãƒ‰: {'âœ…' if results.get('error_get') else 'âŒ'}")
    
    print(f"\\nğŸ”„ ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰åå°„åˆ†æ:")
    print(f"  ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š: {'âœ…' if results.get('reflection_default') else 'âŒ'}")
    print(f"  é«˜ç²¾åº¦è¨­å®š: {'âœ…' if results.get('reflection_precision') else 'âŒ'}")
    print(f"  GETãƒ¡ã‚½ãƒƒãƒ‰: {'âœ…' if results.get('reflection_get') else 'âŒ'}")
    
    print(f"\\nâ±ï¸ æ™‚é–“é…å»¶åˆ†æ:")
    print(f"  ä½é–¾å€¤è¨­å®š: {'âœ…' if results.get('delay_low') else 'âŒ'}")
    print(f"  é«˜é–¾å€¤è¨­å®š: {'âœ…' if results.get('delay_high') else 'âŒ'}")
    print(f"  GETãƒ¡ã‚½ãƒƒãƒ‰: {'âœ…' if results.get('delay_get') else 'âŒ'}")
    
    print(f"\\nğŸ§ª ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°:")
    print(f"  ä¸æ­£ã‚¸ãƒ§ãƒ–ID: {'âœ…' if results.get('error_404') else 'âŒ'}")
    print(f"  ä¸æ­£è¨­å®š: {'âœ…' if results.get('error_config') else 'âŒ'}")
    print(f"  èªè¨¼ãªã—: {'âœ…' if results.get('error_auth') else 'âŒ'}")
    
    # æˆåŠŸç‡è¨ˆç®—
    total_tests = len([k for k in results.keys() if k.startswith(('error_', 'reflection_', 'delay_'))])
    passed_tests = len([k for k, v in results.items() if v and k.startswith(('error_', 'reflection_', 'delay_'))])
    
    if total_tests > 0:
        success_rate = (passed_tests / total_tests) * 100
        print(f"\\nğŸ“ˆ ç·åˆæˆåŠŸç‡: {success_rate:.1f}% ({passed_tests}/{total_tests})")
        
        if success_rate >= 90:
            print("ğŸ‰ å„ªç§€ï¼ã»ã¼å…¨ã¦ã®ãƒ†ã‚¹ãƒˆã«æˆåŠŸã—ã¾ã—ãŸ")
        elif success_rate >= 70:
            print("ğŸ‘ è‰¯å¥½ã§ã™ã€‚å¤§éƒ¨åˆ†ã®ãƒ†ã‚¹ãƒˆã«æˆåŠŸã—ã¾ã—ãŸ")
        else:
            print("âš ï¸ ã„ãã¤ã‹ã®å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„")

def main():
    """
    ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œé–¢æ•°
    """
    print("="*60)
    print("ğŸš€ åˆ†é›¢ã•ã‚ŒãŸè„†å¼±æ€§åˆ†æAPI åŒ…æ‹¬ãƒ†ã‚¹ãƒˆé–‹å§‹")
    print("="*60)
    
    results = {}
    
    # 1. ãƒ­ã‚°ã‚¤ãƒ³
    print("\\n1. ãƒ­ã‚°ã‚¤ãƒ³ä¸­...")
    token = login()
    if not token:
        print("âŒ ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ")
        return
    print("âœ… ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ")
    
    # 2. ãƒ†ã‚¹ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆç”Ÿæˆ
    print("\\n2. åŒ…æ‹¬çš„ãƒ†ã‚¹ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆç”Ÿæˆä¸­...")
    request_id = create_comprehensive_test_requests(token)
    if not request_id:
        print("âŒ ãƒªã‚¯ã‚¨ã‚¹ãƒˆç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ")
        return
    
    # 3. ãƒªã‚¯ã‚¨ã‚¹ãƒˆå®Ÿè¡Œ
    print("\\n3. ãƒªã‚¯ã‚¨ã‚¹ãƒˆå®Ÿè¡Œä¸­...")
    job_id = execute_requests_with_delay(request_id, token)
    if not job_id:
        print("âŒ ã‚¸ãƒ§ãƒ–å®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ")
        return
    
    # 4. ã‚¸ãƒ§ãƒ–å®Œäº†å¾…æ©Ÿ
    print("\\n4. ã‚¸ãƒ§ãƒ–å®Œäº†å¾…æ©Ÿä¸­...")
    if not wait_for_job_completion(job_id, token):
        print("âŒ ã‚¸ãƒ§ãƒ–ãŒå®Œäº†ã—ã¾ã›ã‚“ã§ã—ãŸ")
        return
    
    # 5. è„†å¼±æ€§åˆ†æãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    try:
        test_error_pattern_analysis(job_id, token)
        test_payload_reflection_analysis(job_id, token)
        test_time_delay_analysis(job_id, token)
        test_error_cases(job_id, token)
        
        print("\\n" + "="*60)
        print("ğŸ å…¨ã¦ã®åˆ†æAPIãƒ†ã‚¹ãƒˆå®Œäº†")
        print("="*60)
        
    except Exception as e:
        print(f"âŒ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")

if __name__ == "__main__":
    main() 